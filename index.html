<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="余白">
    <meta name="theme-color" content="#0d0d14">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="manifest" href="manifest.json">
    <title>余白 2026</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Kaku+Gothic+New:wght@300;400;500;700&family=Noto+Serif+JP:wght@300;400;500;600&family=Cormorant+Garamond:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Light Mode (Default - Day) */
            --bg-primary: #faf9f7;
            --bg-secondary: #f5f4f2;
            --bg-card: #ffffff;
            --bg-card-hover: #f8f7f5;
            --text-primary: #1a1a1a;
            --text-secondary: #4a4a4a;
            --text-muted: #8a8a8a;
            --accent-gold: #c4956a;
            --accent-gold-dim: rgba(196, 149, 106, 0.12);
            --accent-sage: #6b8f71;
            --accent-sage-dim: rgba(107, 143, 113, 0.12);
            --accent-blue: #5a7d9a;
            --accent-blue-dim: rgba(90, 125, 154, 0.12);
            --accent-rose: #b07878;
            --border-subtle: rgba(0, 0, 0, 0.06);
            --border-medium: rgba(0, 0, 0, 0.1);
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.04);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.06);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 20px;
            --radius-xl: 28px;
            --font-sans: 'Zen Kaku Gothic New', sans-serif;
            --font-serif: 'Noto Serif JP', serif;
            --font-display: 'Cormorant Garamond', serif;
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
        }
        
        [data-theme="dark"] {
            --bg-primary: #0d0d14;
            --bg-secondary: #151520;
            --bg-card: #1a1a28;
            --bg-card-hover: #22222f;
            --text-primary: #f8f0e3;
            --text-secondary: #a8a4a0;
            --text-muted: #6b6b70;
            --accent-gold: #d4a574;
            --accent-gold-dim: rgba(212, 165, 116, 0.15);
            --accent-sage: #8fa68a;
            --accent-sage-dim: rgba(143, 166, 138, 0.15);
            --accent-blue: #7d9db7;
            --accent-blue-dim: rgba(125, 157, 183, 0.15);
            --accent-rose: #c49191;
            --border-subtle: rgba(248, 240, 227, 0.08);
            --border-medium: rgba(248, 240, 227, 0.12);
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.2);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; overflow: hidden; }
        body { 
            font-family: var(--font-sans); 
            background: var(--bg-primary); 
            color: var(--text-primary); 
            line-height: 1.7; 
            font-weight: 300;
            transition: background 0.5s ease, color 0.5s ease;
        }
        .app { 
            height: 100%; 
            display: flex; 
            flex-direction: column; 
            max-width: 480px; 
            margin: 0 auto; 
            background: var(--bg-primary);
            transition: background 0.5s ease;
        }
        
        /* Header */
        .header { 
            padding: calc(var(--safe-top) + 12px) 20px 16px; 
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-subtle); 
            position: relative; 
            z-index: 100;
            transition: background 0.5s ease;
        }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .logo { font-family: var(--font-serif); font-size: 26px; font-weight: 400; color: var(--text-primary); letter-spacing: 0.15em; }
        .logo span { color: var(--accent-gold); font-size: 10px; vertical-align: super; margin-left: 4px; }
        .header-actions { display: flex; gap: 8px; }
        .header-btn { 
            background: var(--bg-card); 
            border: 1px solid var(--border-subtle); 
            color: var(--text-secondary); 
            padding: 8px; 
            border-radius: 50%; 
            cursor: pointer; 
            transition: all 0.2s;
            box-shadow: var(--shadow-sm);
        }
        .header-btn:hover { background: var(--bg-card-hover); color: var(--accent-gold); }
        .header-btn svg { width: 20px; height: 20px; display: block; }
        .date-nav { display: flex; align-items: center; justify-content: center; gap: 16px; }
        .date-nav button { background: none; border: none; color: var(--text-secondary); padding: 8px; cursor: pointer; border-radius: 50%; transition: all 0.2s; }
        .date-nav button:hover { background: var(--border-subtle); color: var(--text-primary); }
        .date-nav button svg { width: 20px; height: 20px; display: block; }
        .current-date { font-family: var(--font-serif); font-size: 15px; color: var(--text-primary); cursor: pointer; padding: 6px 16px; border-radius: var(--radius-sm); transition: background 0.2s; }
        .current-date:hover { background: var(--border-subtle); }
        .current-date .weekday { color: var(--accent-gold); margin-left: 8px; font-size: 13px; }

        /* Main */
        .main { flex: 1; overflow-y: auto; overflow-x: hidden; padding: 0 0 calc(80px + var(--safe-bottom)); scroll-behavior: smooth; -webkit-overflow-scrolling: touch; }
        .main::-webkit-scrollbar { display: none; }
        .view { display: none; padding: 20px; animation: fadeIn 0.4s ease; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* Time Display */
        .time-section { text-align: center; margin-bottom: 24px; }
        .current-time { font-family: var(--font-display); font-size: 56px; color: var(--text-primary); letter-spacing: 0.05em; }
        .time-period { font-size: 14px; color: var(--text-muted); margin-top: 8px; padding: 6px 16px; display: inline-block; border-radius: 20px; }
        .time-period.morning { background: var(--accent-gold-dim); color: var(--accent-gold); }
        .time-period.evening { background: var(--accent-blue-dim); color: var(--accent-blue); }
        
        /* Fasting Timer */
        .fasting-timer {
            margin-top: 16px;
            padding: 16px 20px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-lg);
            text-align: center;
        }
        .fasting-status {
            font-family: var(--font-display);
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 12px;
        }
        .fasting-status.fasting { color: #f97316; }
        .fasting-status.eating { color: var(--accent-sage); }
        .fasting-progress-bar {
            height: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        .fasting-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #f97316, #fb923c);
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        .fasting-progress-fill.eating {
            background: linear-gradient(90deg, var(--accent-sage), #6b9c70);
        }
        .fasting-info {
            font-size: 12px;
            color: var(--text-muted);
        }
        .fasting-countdown {
            font-family: var(--font-display);
            font-size: 24px;
            font-weight: 700;
            color: #f97316;
            margin: 4px 0;
        }
        .fasting-countdown.eating { color: var(--accent-sage); }
        
         .time-mindset {
            margin-top: 16px; 
            padding: 16px 20px; 
            background: var(--bg-card); 
            border: 1px solid var(--border-subtle); 
            border-radius: var(--radius-lg); 
            text-align: left;
            font-size: 13px;
            line-height: 1.7;
            color: var(--text-secondary);
        }
        .time-mindset-title { 
            font-weight: 600; 
            color: var(--text-primary); 
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .time-mindset-list { margin: 0; padding-left: 16px; }
        .time-mindset-list li { margin-bottom: 4px; }
        .time-mindset-list li:last-child { margin-bottom: 0; }
        .time-mindset-tip { 
            margin-top: 10px; 
            padding: 10px 12px; 
            background: var(--accent-gold-dim); 
            border-radius: var(--radius-md); 
            font-size: 12px;
            color: var(--accent-gold);
        }

        /* Quote Card */
        .quote-card { 
            background: var(--bg-card); 
            border: 1px solid var(--border-subtle); 
            border-radius: var(--radius-xl); 
            padding: 28px 24px; 
            margin-bottom: 24px; 
            position: relative; 
            overflow: hidden;
            box-shadow: var(--shadow-md);
        }
        .quote-card::before { content: '"'; position: absolute; top: -10px; left: 16px; font-family: var(--font-display); font-size: 120px; color: var(--accent-gold); opacity: 0.08; line-height: 1; }
        .quote-text { font-family: var(--font-serif); font-size: 15px; line-height: 2; color: var(--text-primary); margin-bottom: 16px; position: relative; z-index: 1; }
        .quote-source { font-size: 12px; color: var(--text-muted); text-align: right; }

        /* Month Card */
        .month-card { 
            background: linear-gradient(145deg, var(--accent-gold-dim) 0%, var(--bg-card) 60%); 
            border: 1px solid var(--border-subtle); 
            border-radius: var(--radius-xl); 
            padding: 24px; 
            margin-bottom: 24px;
            box-shadow: var(--shadow-md);
        }
        .month-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
        .month-label { font-size: 11px; color: var(--accent-gold); text-transform: uppercase; letter-spacing: 0.2em; margin-bottom: 4px; }
        .month-theme { font-family: var(--font-serif); font-size: 28px; font-weight: 500; color: var(--text-primary); }
        .month-revenue { text-align: right; }
        .month-revenue-label { font-size: 10px; color: var(--text-muted); margin-bottom: 2px; }
        .month-revenue-value { font-family: var(--font-display); font-size: 22px; color: var(--accent-gold); }
        .month-quote { font-family: var(--font-serif); font-size: 13px; color: var(--text-secondary); font-style: italic; padding-left: 12px; border-left: 2px solid var(--accent-gold); opacity: 0.9; }

        /* Section */
        .section { margin-bottom: 28px; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .section-title { font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.15em; font-weight: 500; }
        .section-progress { font-size: 13px; color: var(--accent-sage); font-weight: 500; }
        .section-badge { font-size: 11px; padding: 4px 10px; border-radius: 12px; cursor: pointer; }
        .section-badge.morning { background: var(--accent-gold-dim); color: var(--accent-gold); }
        .section-badge.evening { background: var(--accent-blue-dim); color: var(--accent-blue); }
        .section.highlighted { background: var(--accent-gold-dim); margin: -12px -20px 28px; padding: 20px; border-radius: var(--radius-lg); }
        .section.highlighted.evening { background: var(--accent-blue-dim); }

        /* Habit Item */
        .habit-list { display: flex; flex-direction: column; gap: 10px; }
        .habit-item { 
            display: flex; 
            align-items: center; 
            gap: 14px; 
            background: var(--bg-card); 
            border: 1px solid var(--border-subtle); 
            border-radius: var(--radius-md); 
            padding: 16px 18px; 
            cursor: pointer; 
            transition: all 0.25s ease;
            box-shadow: var(--shadow-sm);
        }
        .habit-item:hover { background: var(--bg-card-hover); border-color: var(--border-medium); }
        .habit-item.completed { background: var(--accent-sage-dim); border-color: rgba(107, 143, 113, 0.3); }
        .habit-checkbox { width: 24px; height: 24px; border: 2px solid var(--text-muted); border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all 0.25s; flex-shrink: 0; }
        .habit-item.completed .habit-checkbox { background: var(--accent-sage); border-color: var(--accent-sage); }
        .habit-checkbox svg { width: 14px; height: 14px; color: transparent; }
        .habit-item.completed .habit-checkbox svg { color: var(--bg-primary); }
        .habit-info { flex: 1; }
        .habit-name { font-size: 15px; color: var(--text-primary); margin-bottom: 2px; }
        .habit-time { font-size: 12px; color: var(--accent-gold); font-weight: 500; }
        .habit-item.completed .habit-name { text-decoration: line-through; opacity: 0.7; }

        /* Health Grid */
        .health-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .health-item { background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); padding: 18px; box-shadow: var(--shadow-sm); }
        .health-icon { font-size: 24px; margin-bottom: 8px; }
        .health-label { font-size: 11px; color: var(--text-muted); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.1em; }
        .health-value input { background: transparent; border: none; color: var(--text-primary); font-family: var(--font-display); font-size: 24px; width: 80px; outline: none; }
        .health-unit { font-size: 12px; color: var(--text-muted); font-family: var(--font-sans); }

        /* Note Card */
        .note-card { background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: var(--radius-lg); padding: 20px; box-shadow: var(--shadow-sm); }
        .note-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px; }
        .note-title { font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.15em; }
        .note-textarea { width: 100%; min-height: 120px; background: transparent; border: none; color: var(--text-primary); font-family: var(--font-serif); font-size: 14px; line-height: 1.9; resize: none; outline: none; }
        .note-textarea::placeholder { color: var(--text-muted); }

        /* Image Upload */
        .image-upload-area { margin-top: 16px; border: 2px dashed var(--border-medium); border-radius: var(--radius-md); padding: 20px; text-align: center; cursor: pointer; transition: all 0.2s; }
        .image-upload-area:hover { border-color: var(--accent-gold); background: var(--accent-gold-dim); }
        .image-upload-area svg { width: 32px; height: 32px; color: var(--text-muted); margin-bottom: 8px; }
        .image-upload-area p { font-size: 12px; color: var(--text-muted); }
        .uploaded-images { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 12px; }
        .uploaded-image { position: relative; aspect-ratio: 1; border-radius: var(--radius-sm); overflow: hidden; }
        .uploaded-image img { width: 100%; height: 100%; object-fit: cover; }
        .uploaded-image .remove-btn { position: absolute; top: 4px; right: 4px; width: 24px; height: 24px; background: rgba(0,0,0,0.7); border: none; border-radius: 50%; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        /* News Section */
        .keyword-tags { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px; }
        .keyword-tag { 
            padding: 8px 14px; 
            background: var(--bg-card); 
            border: 1px solid var(--border-subtle); 
            border-radius: 20px; 
            font-size: 13px; 
            color: var(--text-secondary); 
            cursor: pointer; 
            transition: all 0.2s; 
            display: flex; 
            align-items: center; 
            gap: 8px;
            box-shadow: var(--shadow-sm);
        }
        .keyword-tag:hover { border-color: var(--accent-gold); }
        .keyword-tag .remove { font-size: 16px; opacity: 0.6; line-height: 1; }
        .keyword-tag .remove:hover { opacity: 1; }
        .add-keyword-btn { padding: 8px 14px; background: transparent; border: 2px dashed var(--border-medium); border-radius: 20px; font-size: 13px; color: var(--text-muted); cursor: pointer; }
        .add-keyword-btn:hover { border-color: var(--accent-gold); color: var(--accent-gold); }
        
        .news-card { 
            background: var(--bg-card); 
            border: 1px solid var(--border-subtle); 
            border-radius: var(--radius-lg); 
            overflow: hidden; 
            margin-bottom: 16px;
            box-shadow: var(--shadow-sm);
        }
        .news-card-header { 
            padding: 14px 16px; 
            border-bottom: 1px solid var(--border-subtle); 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            background: var(--accent-gold-dim);
        }
        .news-keyword { font-size: 14px; color: var(--accent-gold); font-weight: 500; }
        .news-link-btn { 
            background: var(--accent-gold); 
            border: none; 
            color: var(--bg-primary); 
            padding: 6px 12px; 
            border-radius: 16px; 
            font-size: 11px; 
            cursor: pointer;
            font-weight: 500;
            text-decoration: none;
            display: inline-block;
        }
        .news-link-btn:hover { opacity: 0.9; }
        .news-list { max-height: 250px; overflow-y: auto; }
        .news-item { 
            padding: 14px 16px; 
            border-bottom: 1px solid var(--border-subtle); 
            cursor: pointer; 
            transition: background 0.2s;
            text-decoration: none;
            display: block;
        }
        .news-item:last-child { border-bottom: none; }
        .news-item:hover { background: var(--bg-card-hover); }
        .news-item-title { font-size: 13px; color: var(--text-primary); line-height: 1.6; margin-bottom: 6px; }
        .news-item-meta { display: flex; justify-content: space-between; align-items: center; }
        .news-item-source { font-size: 11px; color: var(--text-muted); }
        .news-loading { padding: 30px 16px; text-align: center; font-size: 13px; color: var(--text-muted); }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(10px); display: none; align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
        .modal-overlay.active { display: flex; }
        .modal { background: var(--bg-secondary); border: 1px solid var(--border-medium); border-radius: var(--radius-xl); width: 100%; max-width: 400px; max-height: 90vh; overflow-y: auto; animation: modalIn 0.3s ease; box-shadow: var(--shadow-md); }
        @keyframes modalIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 24px; border-bottom: 1px solid var(--border-subtle); }
        .modal-title { font-family: var(--font-serif); font-size: 18px; color: var(--text-primary); }
        .modal-close { background: none; border: none; color: var(--text-muted); cursor: pointer; padding: 8px; }
        .modal-body { padding: 20px 24px; }

        /* Settings */
        .settings-section { margin-bottom: 24px; }
        .settings-section-title { font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .settings-item { padding: 16px; background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); margin-bottom: 8px; }
        .settings-item-label { font-size: 14px; color: var(--text-primary); margin-bottom: 4px; }
        .settings-item-desc { font-size: 12px; color: var(--text-muted); margin-bottom: 12px; }
        .time-input-group { display: flex; align-items: center; gap: 8px; }
        .time-input { background: var(--bg-secondary); border: 1px solid var(--border-medium); border-radius: var(--radius-sm); padding: 10px 14px; color: var(--text-primary); font-family: var(--font-display); font-size: 18px; width: 100px; text-align: center; outline: none; }
        .time-input:focus { border-color: var(--accent-gold); }
        .time-separator { color: var(--text-muted); font-size: 18px; }

        /* Form */
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; font-size: 12px; color: var(--text-muted); margin-bottom: 8px; }
        .form-input { width: 100%; padding: 12px 16px; background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); color: var(--text-primary); font-family: var(--font-sans); font-size: 14px; outline: none; }
        .form-input:focus { border-color: var(--accent-gold); }
        .btn-primary { width: 100%; padding: 14px; background: var(--accent-gold); border: none; border-radius: var(--radius-md); color: white; font-family: var(--font-sans); font-size: 14px; font-weight: 500; cursor: pointer; }
        .btn-primary:hover { opacity: 0.9; }
        
        /* Theme Toggle */
        .theme-toggle-btn { font-size: 13px; font-weight: 500; }
        .theme-toggle-btn:hover { border-color: var(--accent-gold) !important; }
        .theme-toggle-btn.active { background: var(--accent-gold) !important; color: white !important; border-color: var(--accent-gold) !important; }

        /* Calendar */
        .calendar { width: 100%; }
        .calendar-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .calendar-nav button { background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 8px; }
        .calendar-month { font-family: var(--font-serif); font-size: 16px; color: var(--text-primary); }
        .calendar-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-bottom: 8px; }
        .calendar-weekday { text-align: center; font-size: 11px; color: var(--text-muted); padding: 8px 0; }
        .calendar-days { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .calendar-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; font-size: 14px; color: var(--text-secondary); background: none; border: none; border-radius: 50%; cursor: pointer; transition: all 0.2s; position: relative; }
        .calendar-day:hover { background: var(--border-subtle); }
        .calendar-day.today { border: 1px solid var(--accent-gold); color: var(--accent-gold); }
        .calendar-day.selected { background: var(--accent-gold); color: white; }
        .calendar-day.other-month { opacity: 0.3; }

        /* Week View */
        .week-calendar { display: flex; gap: 6px; margin-bottom: 24px; overflow-x: auto; padding: 4px 0; }
        .week-day { flex: 1; min-width: 44px; text-align: center; padding: 12px 8px; background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); cursor: pointer; transition: all 0.2s; box-shadow: var(--shadow-sm); }
        .week-day:hover { border-color: var(--border-medium); }
        .week-day.active { background: var(--accent-gold-dim); border-color: var(--accent-gold); }
        .week-day-name { font-size: 10px; color: var(--text-muted); margin-bottom: 4px; }
        .week-day-num { font-family: var(--font-display); font-size: 18px; color: var(--text-primary); }
        .week-day.active .week-day-num { color: var(--accent-gold); }
        .week-day-progress { width: 100%; height: 3px; background: var(--border-subtle); border-radius: 2px; margin-top: 8px; overflow: hidden; }
        .week-day-progress-bar { height: 100%; background: var(--accent-sage); border-radius: 2px; }

        /* Activity List */
        .activity-list { display: flex; flex-direction: column; gap: 8px; }
        .activity-item { display: flex; align-items: center; justify-content: space-between; background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); padding: 14px 16px; box-shadow: var(--shadow-sm); }
        .activity-info { display: flex; align-items: center; gap: 12px; }
        .activity-icon { font-size: 20px; }
        .activity-name { font-size: 14px; color: var(--text-primary); }
        .activity-day { font-size: 12px; color: var(--text-muted); }
        .activity-status { padding: 6px 12px; border-radius: 16px; font-size: 11px; font-weight: 500; }
        .activity-status.scheduled { background: var(--accent-gold-dim); color: var(--accent-gold); }

        /* Book List */
        .book-list { display: flex; flex-direction: column; gap: 10px; margin-bottom: 12px; }
        .book-item { display: flex; align-items: flex-start; gap: 14px; background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); padding: 16px; cursor: pointer; transition: all 0.2s; box-shadow: var(--shadow-sm); }
        .book-item:hover { border-color: var(--border-medium); }
        .book-item.completed { background: var(--accent-sage-dim); border-color: rgba(107, 143, 113, 0.3); }
        .book-checkbox { width: 22px; height: 22px; border: 2px solid var(--text-muted); border-radius: 4px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; margin-top: 2px; }
        .book-item.completed .book-checkbox { background: var(--accent-sage); border-color: var(--accent-sage); }
        .book-checkbox svg { width: 14px; height: 14px; color: transparent; }
        .book-item.completed .book-checkbox svg { color: var(--bg-primary); }
        .book-info { flex: 1; }
        .book-title { font-size: 14px; color: var(--text-primary); margin-bottom: 3px; }
        .book-author { font-size: 12px; color: var(--text-muted); }
        .book-item.completed .book-title { text-decoration: line-through; opacity: 0.7; }
        .add-book-btn { display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; padding: 14px; background: transparent; border: 2px dashed var(--border-medium); border-radius: var(--radius-md); color: var(--text-muted); font-size: 13px; cursor: pointer; }
        .add-book-btn:hover { border-color: var(--accent-gold); color: var(--accent-gold); }

        /* Goals */
        .goal-card { background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: var(--radius-lg); padding: 18px; margin-bottom: 12px; cursor: pointer; transition: all 0.2s; box-shadow: var(--shadow-sm); }
        .goal-card:hover { border-color: var(--border-medium); }
        .goal-card.completed { background: var(--accent-sage-dim); border-color: rgba(107, 143, 113, 0.3); }
        .goal-header { display: flex; align-items: flex-start; gap: 14px; }
        .goal-checkbox { width: 24px; height: 24px; border: 2px solid var(--text-muted); border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .goal-card.completed .goal-checkbox { background: var(--accent-sage); border-color: var(--accent-sage); }
        .goal-checkbox svg { width: 14px; height: 14px; color: transparent; }
        .goal-card.completed .goal-checkbox svg { color: var(--bg-primary); }
        .goal-content { flex: 1; }
        .goal-title { font-size: 15px; color: var(--text-primary); margin-bottom: 4px; }
        .goal-card.completed .goal-title { text-decoration: line-through; opacity: 0.7; }
        .goal-deadline { font-size: 12px; color: var(--text-muted); }

        /* Month Tabs */
        .month-tabs { display: flex; gap: 8px; overflow-x: auto; padding: 4px 0 16px; margin-bottom: 16px; }
        .month-tabs::-webkit-scrollbar { display: none; }
        .month-tab { flex-shrink: 0; padding: 10px 18px; background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); font-size: 13px; color: var(--text-secondary); cursor: pointer; box-shadow: var(--shadow-sm); }
        .month-tab:hover { border-color: var(--border-medium); }
        .month-tab.active { background: var(--accent-gold-dim); border-color: var(--accent-gold); color: var(--accent-gold); }

        /* Five Year Plan */
        .plan-tabs { display: flex; gap: 8px; margin-bottom: 20px; overflow-x: auto; }
        .plan-tab { flex-shrink: 0; padding: 12px 20px; background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); font-family: var(--font-display); font-size: 18px; color: var(--text-secondary); cursor: pointer; box-shadow: var(--shadow-sm); }
        .plan-tab.active { background: var(--accent-gold-dim); border-color: var(--accent-gold); color: var(--accent-gold); }
        
        .plan-year-card { background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: var(--radius-lg); padding: 24px; margin-bottom: 16px; box-shadow: var(--shadow-sm); }
        .plan-year-card.current { background: linear-gradient(145deg, var(--accent-gold-dim) 0%, var(--bg-card) 40%); }
        .plan-year-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px; }
        .plan-year { font-family: var(--font-display); font-size: 36px; color: var(--accent-gold); }
        .plan-year-theme { font-family: var(--font-serif); font-size: 18px; color: var(--text-primary); margin-top: 4px; }
        .plan-year-revenue { text-align: right; }
        .plan-year-revenue-label { font-size: 11px; color: var(--text-muted); }
        .plan-year-revenue-value { font-family: var(--font-display); font-size: 24px; color: var(--text-primary); }
        .plan-breakdown { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 16px; }
        .plan-breakdown-item { text-align: center; padding: 12px; background: var(--bg-secondary); border-radius: var(--radius-sm); }
        .plan-breakdown-label { font-size: 10px; color: var(--text-muted); margin-bottom: 4px; }
        .plan-breakdown-value { font-size: 14px; color: var(--text-primary); }
        .plan-section { margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--border-subtle); }
        .plan-section-title { font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 12px; }
        .plan-milestones { display: flex; flex-direction: column; gap: 8px; }
        .plan-milestone { display: flex; align-items: flex-start; gap: 12px; padding: 10px 0; }
        .plan-milestone-dot { width: 8px; height: 8px; background: var(--accent-gold); border-radius: 50%; margin-top: 6px; flex-shrink: 0; }
        .plan-milestone-text { font-size: 13px; color: var(--text-secondary); }
        
        /* SMART Goal Accordion */
        .smart-goal-item { 
            background: var(--bg-secondary); 
            border-radius: var(--radius-md); 
            margin-bottom: 8px; 
            overflow: hidden;
            border: 1px solid var(--border-subtle);
            transition: all 0.2s ease;
        }
        .smart-goal-item:hover { border-color: var(--border-medium); }
        .smart-goal-header { 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            padding: 14px 16px; 
            cursor: pointer;
            user-select: none;
        }
        .smart-goal-dot { 
            width: 8px; 
            height: 8px; 
            background: var(--accent-gold); 
            border-radius: 50%; 
            flex-shrink: 0; 
        }
        .smart-goal-title { 
            flex: 1; 
            font-size: 13px; 
            color: var(--text-secondary); 
            line-height: 1.5;
        }
        .smart-goal-toggle { 
            width: 20px; 
            height: 20px; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            color: var(--text-muted);
            transition: transform 0.2s ease;
        }
        .smart-goal-item.open .smart-goal-toggle { transform: rotate(180deg); }
        .smart-goal-details { 
            max-height: 0; 
            overflow: hidden; 
            transition: max-height 0.3s ease;
        }
        .smart-goal-item.open .smart-goal-details { max-height: 500px; }
        .smart-goal-details-inner { 
            padding: 0 16px 16px 36px; 
            border-top: 1px solid var(--border-subtle);
            margin-top: 0;
        }
        .smart-goal-details-list { 
            margin: 12px 0 0 0; 
            padding-left: 16px; 
            font-size: 12px; 
            color: var(--text-muted);
            line-height: 1.8;
        }
        .smart-goal-details-list li { margin-bottom: 4px; }
        .smart-goal-details-list li:last-child { margin-bottom: 0; }
        .plan-quarter { background: var(--bg-secondary); border-radius: var(--radius-md); padding: 16px; margin-bottom: 12px; }
        .plan-quarter-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .plan-quarter-name { font-weight: 500; color: var(--text-primary); }
        .plan-quarter-revenue { font-family: var(--font-display); color: var(--accent-gold); }
        .plan-quarter-events { font-size: 13px; color: var(--text-secondary); }

        /* Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 24px; }
        .stat-card { background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: var(--radius-lg); padding: 20px; text-align: center; box-shadow: var(--shadow-sm); }
        .stat-value { font-family: var(--font-display); font-size: 36px; color: var(--accent-gold); margin-bottom: 4px; }
        .stat-label { font-size: 12px; color: var(--text-muted); }
        
        /* Weekly Report */
        .weekly-report-section { 
            background: var(--bg-card); 
            border: 1px solid var(--border-subtle); 
            border-radius: var(--radius-xl); 
            padding: 20px; 
            margin-bottom: 24px;
            box-shadow: var(--shadow-sm);
        }
        .weekly-report-section .section-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 16px;
        }
        .weekly-report-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: var(--accent-gold);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        .weekly-report-btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .weekly-report-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .weekly-report-content { min-height: 100px; }
        .weekly-report-placeholder { 
            text-align: center; 
            padding: 24px; 
            color: var(--text-secondary);
            font-size: 13px;
        }
        .weekly-stats-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }
        .weekly-stat-item {
            text-align: center;
            padding: 16px 12px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
        }
        .weekly-stat-value { 
            font-family: var(--font-display); 
            font-size: 28px; 
            color: var(--accent-gold);
            margin-bottom: 4px;
        }
        .weekly-stat-label { font-size: 11px; color: var(--text-muted); }
        .weekly-stat-change { font-size: 11px; margin-top: 4px; }
        .weekly-stat-change.positive { color: var(--accent-sage); }
        .weekly-stat-change.negative { color: var(--accent-rose); }
        .weekly-chart {
            margin: 16px 0;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
        }
        .weekly-chart-title { 
            font-size: 12px; 
            color: var(--text-secondary); 
            margin-bottom: 12px;
            font-weight: 500;
        }
        .weekly-chart-bars {
            display: flex;
            align-items: flex-end;
            justify-content: space-between;
            height: 80px;
            gap: 8px;
        }
        .weekly-chart-bar-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }
        .weekly-chart-bar {
            width: 100%;
            background: linear-gradient(180deg, var(--accent-gold) 0%, var(--accent-gold-dim) 100%);
            border-radius: 4px 4px 0 0;
            min-height: 4px;
            transition: height 0.3s ease;
        }
        .weekly-chart-label { font-size: 10px; color: var(--text-muted); }
        .weekly-chart-value { font-size: 10px; color: var(--text-secondary); font-weight: 500; }
        .weekly-ai-comment {
            margin-top: 16px;
            padding: 16px;
            background: linear-gradient(145deg, var(--accent-sage-dim) 0%, var(--bg-secondary) 100%);
            border-radius: var(--radius-md);
            border-left: 3px solid var(--accent-sage);
        }
        .weekly-ai-comment-title {
            font-size: 12px;
            color: var(--accent-sage);
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .weekly-ai-comment-text {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.7;
        }
        .weekly-weight-trend {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            margin-bottom: 12px;
        }
        .weekly-weight-item { text-align: center; }
        .weekly-weight-label { font-size: 10px; color: var(--text-muted); margin-bottom: 2px; }
        .weekly-weight-value { font-family: var(--font-display); font-size: 18px; color: var(--text-primary); }
        .weekly-weight-arrow { font-size: 20px; color: var(--text-muted); }

        /* Guidelines */
        .guidelines { background: linear-gradient(145deg, var(--accent-gold-dim) 0%, var(--bg-card) 60%); border: 1px solid var(--border-subtle); border-radius: var(--radius-xl); padding: 24px; box-shadow: var(--shadow-sm); }
        .guideline-item { display: flex; align-items: flex-start; gap: 14px; padding: 12px 0; border-bottom: 1px solid var(--border-subtle); }
        .guideline-item:last-child { border-bottom: none; padding-bottom: 0; }
        .guideline-icon { width: 32px; height: 32px; background: var(--accent-gold-dim); border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .guideline-icon svg { width: 16px; height: 16px; color: var(--accent-gold); }
        .guideline-text { font-family: var(--font-serif); font-size: 14px; color: var(--text-primary); line-height: 1.7; }

        /* Bottom Nav */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: var(--bg-primary); border-top: 1px solid var(--border-subtle); padding: 10px 0 calc(var(--safe-bottom) + 6px); z-index: 100; transition: background 0.5s ease; }
        .nav-list { display: flex; justify-content: space-around; max-width: 480px; margin: 0 auto; }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 3px; padding: 6px 10px; background: none; border: none; color: var(--text-muted); font-size: 9px; cursor: pointer; transition: color 0.2s; }
        .nav-item:hover { color: var(--text-secondary); }
        .nav-item.active { color: var(--accent-gold); }
        .nav-item svg { width: 22px; height: 22px; }

        /* Toast */
        .toast { position: fixed; bottom: calc(90px + var(--safe-bottom)); left: 50%; transform: translateX(-50%) translateY(100px); background: var(--accent-sage); color: white; padding: 12px 24px; border-radius: var(--radius-md); font-size: 13px; font-weight: 500; opacity: 0; transition: all 0.3s; z-index: 200; }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        
        /* Theme indicator */
        .theme-indicator { font-size: 11px; color: var(--text-muted); margin-left: 8px; }
        
        /* Daily Paper */
        .daily-paper-card { 
            background: linear-gradient(145deg, #f5f0e8 0%, #ebe5d9 100%); 
            border: 1px solid rgba(139, 90, 43, 0.2); 
            border-radius: var(--radius-lg); 
            padding: 20px; 
            margin-bottom: 20px;
            box-shadow: var(--shadow-md);
        }
        [data-theme="dark"] .daily-paper-card {
            background: linear-gradient(145deg, #2a2520 0%, #1f1a16 100%);
            border-color: rgba(212, 165, 116, 0.2);
        }
        .paper-card-header { display: flex; align-items: center; gap: 14px; margin-bottom: 16px; }
        .paper-card-icon { font-size: 32px; }
        .paper-card-title { font-family: var(--font-serif); font-size: 18px; color: var(--text-primary); font-weight: 500; }
        .paper-card-desc { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
        .paper-generate-btn { 
            width: 100%; 
            padding: 14px; 
            background: linear-gradient(135deg, #8b5a2b 0%, #6b4423 100%); 
            border: none; 
            border-radius: var(--radius-md); 
            color: #f5f0e8; 
            font-family: var(--font-serif); 
            font-size: 15px; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 8px;
            transition: all 0.2s;
        }
        .paper-generate-btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .paper-generate-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .paper-generate-btn.loading { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 0.6; } 50% { opacity: 1; } }
        
        /* Daily Paper Full View */
        .daily-paper {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #f8f5f0;
            z-index: 1000;
            overflow-y: auto;
            overflow-x: hidden;
            padding: calc(var(--safe-top) + 20px) 20px calc(var(--safe-bottom) + 20px);
            animation: paperIn 0.3s ease;
            -webkit-overflow-scrolling: touch;
        }
        [data-theme="dark"] .daily-paper { background: #1a1714; }
        @keyframes paperIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
        
        .paper-header { 
            text-align: center; 
            padding: 20px 16px 20px; 
            border-bottom: 3px double #8b5a2b; 
            margin-bottom: 20px; 
        }
        .paper-title { 
            font-family: var(--font-serif); 
            font-size: 36px; 
            font-weight: 600; 
            color: #2c1810; 
            letter-spacing: 0.2em; 
            margin-bottom: 8px; 
        }
        [data-theme="dark"] .paper-title { color: #f5f0e8; }
        .paper-date { 
            font-family: var(--font-display); 
            font-size: 14px; 
            color: #8b5a2b; 
            margin-bottom: 8px; 
        }
        .paper-subtitle { 
            font-family: var(--font-serif); 
            font-size: 12px; 
            color: #6b5a4a; 
            font-style: italic; 
        }
        [data-theme="dark"] .paper-subtitle { color: #a89888; }
        
        .paper-content { 
            max-width: 100%; 
            width: 100%;
            margin: 0 auto; 
            padding: 0; 
            overflow: hidden;
            box-sizing: border-box;
        }
        .paper-section { 
            margin-bottom: 24px; 
            padding-bottom: 16px; 
            border-bottom: 1px solid rgba(139, 90, 43, 0.2);
            overflow: hidden;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        .paper-section:last-child { border-bottom: none; }
        .paper-section-title { 
            font-family: var(--font-serif); 
            font-size: 16px; 
            font-weight: 600; 
            color: #8b5a2b; 
            margin-bottom: 12px; 
            display: flex; 
            align-items: flex-start; 
            gap: 8px;
            flex-wrap: wrap;
        }
        .paper-section-content { 
            font-family: var(--font-serif); 
            font-size: 14px; 
            line-height: 2; 
            color: #2c1810; 
            text-align: justify;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        [data-theme="dark"] .paper-section-content { color: #e8e0d8; }
        .paper-headline { 
            font-family: var(--font-serif); 
            font-size: 16px; 
            font-weight: 600; 
            color: #2c1810; 
            margin-bottom: 8px; 
        }
        [data-theme="dark"] .paper-headline { color: #f5f0e8; }
        .paper-summary { 
            font-size: 13px; 
            color: #4a3a2a; 
            margin-bottom: 16px; 
            padding-left: 12px; 
            border-left: 2px solid #8b5a2b; 
        }
        [data-theme="dark"] .paper-summary { color: #c8b8a8; }
        
        .paper-footer { 
            text-align: center; 
            padding: 24px 20px calc(var(--safe-bottom) + 24px); 
        }
        .paper-close-btn { 
            padding: 12px 32px; 
            background: transparent; 
            border: 2px solid #8b5a2b; 
            border-radius: var(--radius-md); 
            color: #8b5a2b; 
            font-family: var(--font-serif); 
            font-size: 14px; 
            cursor: pointer; 
        }
        .paper-close-btn:hover { background: rgba(139, 90, 43, 0.1); }
        
        /* Paper Archive */
        .paper-archive-list { display: flex; flex-direction: column; gap: 10px; }
        .paper-archive-empty { text-align: center; padding: 20px; color: var(--text-muted); font-size: 13px; }
        .paper-archive-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: linear-gradient(145deg, #f5f0e8 0%, #ebe5d9 100%);
            border: 1px solid rgba(139, 90, 43, 0.2);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s;
        }
        [data-theme="dark"] .paper-archive-item {
            background: linear-gradient(145deg, #2a2520 0%, #1f1a16 100%);
            border-color: rgba(212, 165, 116, 0.2);
        }
        .paper-archive-item:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .paper-archive-date { font-family: var(--font-serif); font-size: 14px; color: var(--text-primary); }
        .paper-archive-headline { font-size: 12px; color: var(--text-muted); margin-top: 4px; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .paper-archive-badge { padding: 4px 10px; background: #8b5a2b; color: #f5f0e8; font-size: 10px; border-radius: 12px; }
    </style>
</head>
<body>
    <div class="app">
        <header class="header">
            <div class="header-top">
                <div class="logo">余白<span>2026</span></div>
                <div class="header-actions">
                    <button class="header-btn" onclick="openSettings()" title="設定">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                    </button>
                </div>
            </div>
            <div class="date-nav">
                <button id="prevDay"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg></button>
                <div class="current-date" id="currentDate" onclick="openCalendar()"><span class="date-text"></span><span class="weekday"></span></div>
                <button id="nextDay"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg></button>
            </div>
        </header>
        <main class="main">
            <!-- Today View -->
            <div class="view active" id="todayView">
                <div class="time-section">
                    <div class="current-time" id="currentTime">00:00</div>
                    <div class="time-period" id="timePeriod"></div>
                    <div class="fasting-timer" id="fastingTimer">
                        <div class="fasting-status" id="fastingStatus">🍽️ 食事OK</div>
                        <div class="fasting-progress-bar">
                            <div class="fasting-progress-fill" id="fastingProgressFill"></div>
                        </div>
                        <div class="fasting-info" id="fastingInfo">次の断食開始: 21:00</div>
                    </div>
                    <div class="time-mindset" id="timeMindset"></div>
                </div>
                <div class="quote-card"><p class="quote-text" id="dailyQuote"></p><p class="quote-source">— 質量と余白の間で</p></div>
                <div class="month-card">
                    <div class="month-card-header">
                        <div><div class="month-label">今月のテーマ</div><div class="month-theme" id="monthTheme">始動</div></div>
                    </div>
                    <p class="month-quote" id="monthQuote"></p>
                </div>
                <div class="section" id="morningSection">
                    <div class="section-header"><span class="section-title">🌅 朝のルーティン</span><span class="section-badge morning" id="morningTimeBadge" onclick="openSettings()">7:00〜</span></div>
                    <div class="section-header"><span></span><span class="section-progress" id="morningProgress">0/5</span></div>
                    <div class="habit-list" id="morningHabits"></div>
                </div>
                <div class="section" id="daytimeSection">
                    <div class="section-header"><span class="section-title">☀️ 日中のルーティン</span><span class="section-badge" style="background: var(--accent-sage-dim); color: var(--accent-sage);" id="daytimeTimeBadge">11:00〜</span></div>
                    <div class="section-header"><span style="font-size: 11px; color: var(--accent-sage);">14時間ファスティング後</span><span class="section-progress" id="daytimeProgress">0/5</span></div>
                    <div class="habit-list" id="daytimeHabits"></div>
                </div>
                <div class="section" id="eveningSection">
                    <div class="section-header"><span class="section-title">🌆 夕方のルーティン</span><span class="section-badge evening" id="eveningTimeBadge" onclick="openSettings()">20:00〜</span></div>
                    <div class="section-header"><span style="font-size: 11px; color: var(--accent-blue);">最後の食事は21時まで</span><span class="section-progress" id="eveningProgress">0/4</span></div>
                    <div class="habit-list" id="eveningHabits"></div>
                </div>
                <div class="section" id="nightSection">
                    <div class="section-header"><span class="section-title">🌙 夜のルーティン</span><span class="section-badge" style="background: rgba(139, 92, 246, 0.15); color: #8b5cf6;" id="nightTimeBadge">22:00〜</span></div>
                    <div class="section-header"><span></span><span class="section-progress" id="nightProgress">0/3</span></div>
                    <div class="habit-list" id="nightHabits"></div>
                </div>
                <div class="section" id="strengthSection">
                    <div class="section-header"><span class="section-title">💪 筋トレ（週3回）</span><span class="section-badge" style="background: var(--accent-rose); color: white;" id="strengthDayBadge">月・水・金</span></div>
                    <div class="section-header"><span></span><span class="section-progress" id="strengthProgress">0/3</span></div>
                    <div class="habit-list" id="strengthHabits"></div>
                </div>
                <div class="section"><div class="section-header"><span class="section-title">ヘルスケア</span></div><div class="health-grid" id="healthGrid"></div></div>
                <div class="section">
                    <div class="note-card">
                        <div class="note-header"><span class="note-title">今日の記録</span></div>
                        <textarea class="note-textarea" id="dailyNote" placeholder="今日の気づき、感謝、振り返りを記録する..."></textarea>
                        <div class="image-upload-area" id="imageUploadArea"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg><p>画像を追加</p></div>
                        <input type="file" id="imageInput" accept="image/*" multiple style="display: none;">
                        <div class="uploaded-images" id="uploadedImages"></div>
                    </div>
                </div>
            </div>
            
            <!-- News View -->
            <div class="view" id="newsView">
                <!-- 余白新聞 -->
                <div class="daily-paper" id="dailyPaper" style="display: none;">
                    <div class="paper-header">
                        <div class="paper-title">余白新聞</div>
                        <div class="paper-date" id="paperDate"></div>
                        <div class="paper-subtitle">— 質量と余白の間で、今日を知る —</div>
                    </div>
                    <div class="paper-content" id="paperContent"></div>
                    <div class="paper-footer">
                        <button class="paper-close-btn" onclick="closeDailyPaper()">閉じる</button>
                    </div>
                </div>
                
                <!-- 余白新聞生成・表示エリア -->
                <div class="section">
                    <div class="daily-paper-card" id="dailyPaperCard">
                        <div class="paper-card-header">
                            <span class="paper-card-icon">📰</span>
                            <div>
                                <div class="paper-card-title" id="paperCardTitle">今日の余白新聞</div>
                                <div class="paper-card-desc" id="paperStatus">AIがニュースを要約します</div>
                            </div>
                        </div>
                        <div id="paperActionArea">
                            <button class="paper-generate-btn" id="generatePaperBtn" onclick="generateDailyPaper()">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
                                余白新聞を生成
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- 過去の余白新聞アーカイブ -->
                <div class="section">
                    <div class="section-header"><span class="section-title">📚 余白新聞アーカイブ</span></div>
                    <div class="paper-archive-list" id="paperArchiveList">
                        <div class="paper-archive-empty">まだ余白新聞がありません</div>
                    </div>
                </div>
                
                <div class="section">
                    <div class="section-header"><span class="section-title">ニュースキーワード</span></div>
                    <div class="keyword-tags" id="keywordTags"></div>
                </div>
                <div id="newsContainer"></div>
            </div>
            
            <!-- Week View -->
            <div class="view" id="weekView">
                <div class="week-calendar" id="weekCalendar"></div>
                <div class="section"><div class="section-header"><span class="section-title">週間アクティビティ</span></div><div class="activity-list" id="weeklyActivities"></div></div>
                <div class="section"><div class="section-header"><span class="section-title">今月の読書</span><span class="section-progress" id="bookProgress">0/5</span></div><div class="book-list" id="bookList"></div><button class="add-book-btn" onclick="openAddBookModal()"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>本を追加</button></div>
            </div>
            
            <!-- Goals View -->
            <div class="view" id="goalsView">
                <div class="section"><div class="section-header"><span class="section-title">2026年 年間目標</span></div><div id="yearGoals"></div></div>
                <div class="month-tabs" id="monthTabs"></div>
                <div class="section"><div class="section-header"><span class="section-title" id="monthGoalsTitle">1月の目標</span></div><div id="monthGoals"></div></div>
            </div>
            
            <!-- Plan View -->
            <div class="view" id="planView">
                <div class="quote-card" style="margin-bottom: 24px;"><p class="quote-text">質量と余白の間で。2030年へ向けて。</p><p class="quote-source">— 豊かな後悔の多い人生を</p></div>
                <div class="plan-tabs" id="planTabs"></div>
                <div id="fiveYearPlan"></div>
            </div>
            
            <!-- Stats View -->
            <div class="view" id="statsView">
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-value" id="totalStreak">0</div><div class="stat-label">継続日数</div></div>
                    <div class="stat-card"><div class="stat-value" id="totalHabits">0</div><div class="stat-label">完了した習慣</div></div>
                    <div class="stat-card"><div class="stat-value" id="totalGoals">0</div><div class="stat-label">達成した目標</div></div>
                    <div class="stat-card"><div class="stat-value" id="totalBooks">0</div><div class="stat-label">読んだ本</div></div>
                </div>
                
                <!-- 週間振り返りレポート -->
                <div class="weekly-report-section">
                    <div class="section-header">
                        <span class="section-title">📊 週間振り返りレポート</span>
                        <button class="weekly-report-btn" onclick="generateWeeklyReport()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
                            レポート生成
                        </button>
                    </div>
                    <div class="weekly-report-content" id="weeklyReportContent">
                        <div class="weekly-report-placeholder">
                            <p>過去7日間の習慣達成率、体重推移、読書量をまとめたレポートを生成します。</p>
                            <p style="font-size: 12px; color: var(--text-muted); margin-top: 8px;">「レポート生成」ボタンを押してください</p>
                        </div>
                    </div>
                </div>
                <div class="guidelines">
                    <div class="section-title" style="margin-bottom: 16px;">年間指針</div>
                    <div class="guideline-item"><div class="guideline-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2z"/></svg></div><p class="guideline-text">批評家にならず、手を動かし続ける</p></div>
                    <div class="guideline-item"><div class="guideline-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg></div><p class="guideline-text">脆弱性を認め合う関係性を作る</p></div>
                    <div class="guideline-item"><div class="guideline-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg></div><p class="guideline-text">不可逆性と一回性を大切にする</p></div>
                    <div class="guideline-item"><div class="guideline-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/></svg></div><p class="guideline-text">エッセンシャルワーカーが誰よりも幸せであってほしい</p></div>
                </div>
                <div class="guidelines" style="margin-top: 20px; background: linear-gradient(145deg, var(--accent-blue-dim) 0%, var(--bg-card) 60%);">
                    <div class="section-title" style="margin-bottom: 16px;">🧠 メンタルルール（2週間限定プログラム）</div>
                    <div class="guideline-item"><div class="guideline-icon" style="background: var(--accent-blue-dim);"><svg viewBox="0 0 24 24" fill="none" stroke="var(--accent-blue)" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg></div><p class="guideline-text">頭が回らない＝意志不足ではなく休憩不足</p></div>
                    <div class="guideline-item"><div class="guideline-icon" style="background: var(--accent-blue-dim);"><svg viewBox="0 0 24 24" fill="none" stroke="var(--accent-blue)" stroke-width="2"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg></div><p class="guideline-text">夜は自己評価・反省をしない</p></div>
                    <div class="guideline-item"><div class="guideline-icon" style="background: var(--accent-blue-dim);"><svg viewBox="0 0 24 24" fill="none" stroke="var(--accent-blue)" stroke-width="2"><path d="M18 8h1a4 4 0 0 1 0 8h-1M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/><line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/></svg></div><p class="guideline-text">食事と酒を感情処理に使わない</p></div>
                    <div class="guideline-item"><div class="guideline-icon" style="background: var(--accent-blue-dim);"><svg viewBox="0 0 24 24" fill="none" stroke="var(--accent-blue)" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 8v4l3 3"/></svg></div><p class="guideline-text">7割達成でOK・翌日リセット</p></div>
                </div>
            </div>
        </main>
        
        <nav class="bottom-nav">
            <div class="nav-list">
                <button class="nav-item active" data-view="todayView"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>今日</button>
                <button class="nav-item" data-view="newsView"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 20H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v1m2 13a2 2 0 0 1-2-2V7m2 13a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-2m-4-3H9M7 16h6M7 12h6"/></svg>ニュース</button>
                <button class="nav-item" data-view="weekView"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>週間</button>
                <button class="nav-item" data-view="goalsView"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>目標</button>
                <button class="nav-item" data-view="planView"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>計画</button>
                <button class="nav-item" data-view="statsView"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>統計</button>
            </div>
        </nav>
    </div>

    <!-- Modals -->
    <div class="modal-overlay" id="calendarModal"><div class="modal"><div class="modal-header"><span class="modal-title">日付を選択</span><button class="modal-close" onclick="closeCalendar()"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg></button></div><div class="modal-body"><div class="calendar"><div class="calendar-nav"><button onclick="prevMonth()"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg></button><span class="calendar-month" id="calendarMonth"></span><button onclick="nextMonth()"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg></button></div><div class="calendar-weekdays"><div class="calendar-weekday">日</div><div class="calendar-weekday">月</div><div class="calendar-weekday">火</div><div class="calendar-weekday">水</div><div class="calendar-weekday">木</div><div class="calendar-weekday">金</div><div class="calendar-weekday">土</div></div><div class="calendar-days" id="calendarDays"></div></div></div></div></div>
    
    <div class="modal-overlay" id="settingsModal"><div class="modal"><div class="modal-header"><span class="modal-title">設定</span><button class="modal-close" onclick="closeSettings()"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg></button></div><div class="modal-body">
        <div class="settings-section"><div class="settings-section-title">🌅 朝のルーティン開始時刻</div><div class="settings-item"><div class="settings-item-label">開始時刻を設定</div><div class="settings-item-desc">この時刻から朝ルーティンが始まります</div><div class="time-input-group"><input type="time" class="time-input" id="morningStart" value="07:00"></div></div></div>
        <div class="settings-section"><div class="settings-section-title">🌙 夜のルーティン開始時刻</div><div class="settings-item"><div class="settings-item-label">開始時刻を設定</div><div class="settings-item-desc">この時刻から夜ルーティンが始まります</div><div class="time-input-group"><input type="time" class="time-input" id="eveningStart" value="20:00"></div></div></div>
        <button class="btn-primary" onclick="saveSettings()">保存する</button>
        
        <div class="settings-section" style="margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border-subtle);">
            <div class="settings-section-title">📰 余白新聞（AI設定）</div>
            
            <div class="settings-item">
                <div class="settings-item-label">OpenAI APIキー <span style="color: var(--accent-rose);">必須</span></div>
                <div class="settings-item-desc">余白新聞のAI生成に使用します（GPT-4o）</div>
                <input type="password" class="form-input" id="openaiApiKey" placeholder="sk-..." style="margin-top: 8px;">
                <button class="btn-primary" style="margin-top: 12px; background: var(--accent-sage);" onclick="saveOpenAIKey()">OpenAI APIキーを保存</button>
            </div>
            
            <div class="settings-item" style="margin-top: 20px;">
                <div class="settings-item-label">NewsData.io APIキー <span style="color: var(--text-muted);">推奨</span></div>
                <div class="settings-item-desc">
                    実際のニュース取得に使用（無料: 200件/日）<br>
                    <a href="https://newsdata.io/" target="_blank" style="color: var(--accent-blue); text-decoration: underline;">NewsData.io で無料登録 →</a>
                </div>
                <input type="password" class="form-input" id="newsdataApiKey" placeholder="pub_..." style="margin-top: 8px;">
                <button class="btn-primary" style="margin-top: 12px; background: var(--accent-blue);" onclick="saveNewsDataKey()">NewsData APIキーを保存</button>
            </div>
            
            <div style="margin-top: 16px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; font-size: 12px; color: var(--text-muted);">
                💡 <strong>APIキーについて</strong><br>
                • OpenAI: 必須（余白新聞生成に使用）<br>
                • NewsData.io: 推奨（高品質なニュース取得）<br>
                • APIキーがなくてもGoogle News RSSで取得を試みます
            </div>
        </div>
        
        <div class="settings-section" style="margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border-subtle);">
            <div class="settings-section-title">🌓 テーマ設定</div>
            <div class="settings-item">
                <div class="settings-item-label">表示モード</div>
                <div class="settings-item-desc">自動は時間帯（6時〜18時: ライト、18時〜6時: ダーク）で切り替わります</div>
                <div style="display: flex; gap: 8px; margin-top: 12px;">
                    <button class="theme-toggle-btn" data-theme="auto" onclick="setThemeMode('auto')" style="flex: 1; padding: 10px 16px; border-radius: var(--radius-md); border: 1px solid var(--border-medium); background: var(--bg-secondary); color: var(--text-secondary); cursor: pointer; transition: all 0.2s;">
                        🔄 自動
                    </button>
                    <button class="theme-toggle-btn" data-theme="light" onclick="setThemeMode('light')" style="flex: 1; padding: 10px 16px; border-radius: var(--radius-md); border: 1px solid var(--border-medium); background: var(--bg-secondary); color: var(--text-secondary); cursor: pointer; transition: all 0.2s;">
                        ☀️ ライト
                    </button>
                    <button class="theme-toggle-btn" data-theme="dark" onclick="setThemeMode('dark')" style="flex: 1; padding: 10px 16px; border-radius: var(--radius-md); border: 1px solid var(--border-medium); background: var(--bg-secondary); color: var(--text-secondary); cursor: pointer; transition: all 0.2s;">
                        🌙 ダーク
                    </button>
                </div>
            </div>
        </div>
        
        <div class="settings-section" style="margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border-subtle);">
            <div class="settings-section-title">🔄 アプリの更新</div>
            <div class="settings-item">
                <div class="settings-item-label">最新版に更新</div>
                <div class="settings-item-desc">ホーム画面に追加している場合、更新が反映されないことがあります</div>
                <button class="btn-primary" style="margin-top: 12px; background: var(--accent-blue);" onclick="forceUpdateApp()">アプリを更新する</button>
            </div>
        </div>
        
        <div class="settings-section" style="margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border-subtle);">
            <div class="settings-section-title">ℹ️ アプリ情報</div>
            <div class="settings-item">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span class="settings-item-label">バージョン</span>
                    <span style="color: var(--text-muted); font-family: var(--font-display);" id="appVersion">v1.2.0</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px;">
                    <span class="settings-item-label">最終更新</span>
                    <span style="color: var(--text-muted); font-size: 12px;" id="appLastUpdate">2026-01-10</span>
                </div>
            </div>
        </div>
    </div></div></div>
    
    <div class="modal-overlay" id="addBookModal"><div class="modal"><div class="modal-header"><span class="modal-title">本を追加</span><button class="modal-close" onclick="closeAddBookModal()"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg></button></div><div class="modal-body"><div class="form-group"><label class="form-label">タイトル</label><input type="text" class="form-input" id="bookTitleInput" placeholder="本のタイトル"></div><div class="form-group"><label class="form-label">著者</label><input type="text" class="form-input" id="bookAuthorInput" placeholder="著者名"></div><button class="btn-primary" onclick="addCustomBook()">追加する</button></div></div></div>
    
    <div class="modal-overlay" id="addKeywordModal"><div class="modal"><div class="modal-header"><span class="modal-title">キーワードを追加</span><button class="modal-close" onclick="closeAddKeywordModal()"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg></button></div><div class="modal-body"><div class="form-group"><label class="form-label">キーワード</label><input type="text" class="form-input" id="keywordInput" placeholder="例: AI, 認知症, アート"></div><button class="btn-primary" onclick="addKeyword()">追加する</button></div></div></div>
    
    <div class="toast" id="toast">保存しました</div>

    <script>
        // ============================================
        // APP VERSION
        // ============================================
        const APP_VERSION = 'v3.9.0';
        const APP_LAST_UPDATE = '2026-01-11';
        
        // ============================================
        // DATA
        // ============================================
        const QUOTES = [
            "エッセンシャルワーカーが誰よりも幸せであってほしい。この祈りを、祈りのままにしない。",
            "豊かな後悔とは、起こらなかったことや起こさなかった過去を責めるのではなく、起こらなかったまま美しく残しておく態度のことだ。",
            "傍にいるということは、相手を変えようとしないことだ。助けようとしないことだ。ただ、そこにいること。",
            "環世界の違いを認め、尊重することが、真の対話の前提条件となる。",
            "苦痛もまた、発酵の素材になり得る。",
            "余白とは、効率性の論理から外れたものだ。しかし、人間として生きるためには、そのような余白が不可欠だ。",
            "批評家にならず、手を動かし続ける。",
            "脆弱性を認め合う関係性を、どれだけ作れるか。",
            "後悔は、選択の証だ。後悔できるということは、選択肢があったということ。",
            "人間からすべてを奪うことができる。ただ一つのことを除いて。それは、与えられた環境の中で自らの態度を選ぶという、人間の最後の自由である。",
            "なぜ生きるかを知っている者は、どのように生きることにも耐える。",
            "私たちの時間は有限だ。限られた時間の中で、何を大切にし、何を選び取るか。",
            "質量と余白の間で。豊かな後悔の多い人生を。",
            "私に必要な経験をください。まだあるとするのなら、それを私にください。"
        ];

        const MONTHS = {
            1: { theme: '始動', revenue: '20万', quote: '年間計画確定、ドラム練習開始、ファスティング習慣化', goals: ['年間計画確定・共有', 'ドラム練習開始', 'ファスティング習慣化', '朝ルーティン定着', '投資家リスト作成', 'note記事2本', '美術展3回', '読書5冊'] },
            2: { theme: '深掘り', revenue: '25万', quote: 'MBA集中、コーチング研修申込', goals: ['MBA（財務・会計）集中', 'コーチング研修申込', '脆弱性論文3本', 'ピッチ練習10回', '読書5冊', '美術展3回'] },
            3: { theme: '対話', revenue: '30万', quote: '乃木坂物件探し、yohaku営業強化', goals: ['乃木坂物件内見3件', '投資家面談3件', 'NVCワークショップ', '読書5冊', '美術展3回'] },
            4: { theme: '移転', revenue: '35万', quote: '乃木坂引越し、写真展企画開始', goals: ['乃木坂引越し完了', '写真展企画書作成', 'フィルム5本撮影', '読書5冊', '美術展3回'] },
            5: { theme: '事業', revenue: '45万', quote: 'シード調達、PxDT上期成果', goals: ['yohaku月商50万円', 'PxDT上期成果まとめ', '投資家面談5件', '読書5冊', '美術展3回'] },
            6: { theme: '評価', revenue: '50万', quote: 'PxDT上期評価、上半期振り返り', goals: ['PxDT上期評価面談', '上半期総振り返り', 'コーチング研修開始', '読書4冊', '美術展3回'] },
            7: { theme: '継承', revenue: '55万', quote: '資格研修集中、広島', goals: ['コーチング資格研修', '戦争と記憶のnote', '広島訪問計画確定', '読書5冊', '美術展3回'] },
            8: { theme: '祈り', revenue: '55万', quote: '8月6日、傍にいることの意味', goals: ['8/6 広島訪問', '資格試験準備', '写真選定', '読書4冊'] },
            9: { theme: '資格', revenue: '60万', quote: 'コーチング資格試験、写真展準備', goals: ['コーチング資格合格', '写真展準備本格化', 'プロトタイプ開発', '読書5冊', '美術展3回'] },
            10: { theme: '接続', revenue: '70万', quote: 'テクノロジーとケアの間', goals: ['yohaku月商80万円', 'テクノロジー×ケア論考', '写真展告知', '読書5冊', '美術展3回'] },
            11: { theme: '発表', revenue: '85万', quote: 'フィルム写真展開催、スイス準備', goals: ['写真展開催・成功', 'PxDT下期成果', 'スイス渡航準備', '読書5冊', '美術展2回'] },
            12: { theme: '達成', revenue: '100万', quote: 'yohaku月商100万、スイス渡航', goals: ['yohaku月商100万円', 'PxDT下期評価・昇格', 'スイス渡航', '2026年総括note', '2027年計画策定', '読書4冊'] }
        };

        const YEAR_GOALS = [
            { text: 'yohaku月商100万円達成', deadline: '12月' },
            { text: 'PxDT昇格・昇給', deadline: '評価期' },
            { text: 'コーチング資格取得', deadline: '9月' },
            { text: 'フィルム写真展開催', deadline: '11月' },
            { text: 'ドラム基礎習得', deadline: '通年' },
            { text: 'MBA科目修了', deadline: '通年' },
            { text: '乃木坂へ引越し', deadline: '4月' },
            { text: 'スイス渡航', deadline: '12月' }
        ];

        // 朝ルーティン（7:00〜）- 14時間ファスティング対応
        const MORNING_HABITS = [
            { id: 'water', name: '起床後すぐ水を飲む（500ml）', duration: 2 },
            { id: 'sunlight', name: '日光を浴びる（5分）', duration: 5 },
            { id: 'morning_move', name: '軽く歩く or 体を動かす（5分）', duration: 5 },
            { id: 'weight', name: 'トイレ後に体重測定', duration: 2 },
            { id: 'caffeine', name: 'カフェインは午前中のみ ✓', duration: 1 }
        ];

        // 日中ルーティン（11:00〜）- 14時間ファスティング後の食事開始
        const DAYTIME_HABITS = [
            { id: 'lunch', name: '昼食：高タンパク・低脂質・低糖質（11時以降）', duration: 30 },
            { id: 'no_snack', name: '甘い物・間食をしない ✓', duration: 1 },
            { id: 'hydration', name: '水をこまめに飲む（合計2〜3L）✓', duration: 1 },
            { id: 'walk_17', name: '17時前後に5分歩く or ストレッチ', duration: 5 },
            { id: 'walking', name: 'ウォーキング合計60〜90分', duration: 90 }
        ];

        // 夕方ルーティン（20:00〜）- 最後の食事は21時まで
        const EVENING_HABITS = [
            { id: 'dinner', name: '夕食（20:00-21:00）→ 14時間ファスティング開始', duration: 60 },
            { id: 'work_end', name: '21:00に仕事終了（PCを閉じる）', duration: 5 },
            { id: 'review', name: '今日やったことを3つ書く（評価しない）', duration: 10 },
            { id: 'reset', name: '散歩 or シャワー（15分・考え事禁止）', duration: 15 }
        ];

        // 夜ルーティン（22:00〜）- 判断禁止ゾーン
        const NIGHT_HABITS = [
            { id: 'no_calorie', name: '22時以降はノンカロリーのみ ✓', duration: 1 },
            { id: 'no_decision', name: '判断・思考が必要な作業をしない ✓', duration: 1 },
            { id: 'bed', name: '0時前に布団に入る', duration: 10 }
        ];

        // 週3回の筋トレ
        const STRENGTH_HABITS = [
            { id: 'squat', name: 'スクワット20回×3', duration: 10 },
            { id: 'pushup', name: '腕立て10回×3', duration: 10 },
            { id: 'plank', name: 'プランク30秒×3', duration: 5 }
        ];

        const WEEKLY_ACTIVITIES = [
            { id: 'mba', name: 'MBA学習', icon: '📚', day: '月・水・日' },
            { id: 'drum', name: 'ドラム練習', icon: '🥁', day: '火・木' },
            { id: 'nvc', name: 'NVCセッション', icon: '💬', day: '火' },
            { id: 'film', name: 'フィルム撮影', icon: '📷', day: '土・日' },
            { id: 'art', name: '美術展', icon: '🎨', day: '土・日' },
            { id: 'tea', name: '茶道', icon: '🍵', day: '月1回 土曜' },
            { id: 'fasting', name: '24hファスティング', icon: '🌙', day: '月1回' }
        ];

        const MONTHLY_BOOKS = {
            1: [{ title: 'プロフェッショナル原論', author: '波頭亮' }, { title: 'ケアの倫理', author: '岡野八代' }, { title: '存在と時間（入門書）', author: 'ハイデガー' }, { title: '人間失格', author: '太宰治' }, { title: '現代アートとは何か', author: '小崎哲哉' }],
            2: [{ title: 'もうひとつの声で', author: 'ギリガン' }, { title: 'MBAファイナンス', author: 'グロービス' }, { title: '論語（新訳）', author: '' }, { title: 'こころ', author: '夏目漱石' }, { title: '美術の物語', author: 'ゴンブリッチ' }],
            3: [{ title: 'ケアの倫理と共感', author: 'スロート' }, { title: 'NVC 人と人との関係にいのちを吹き込む法', author: 'ローゼンバーグ' }],
            4: [{ title: '明るい部屋', author: 'バルト' }, { title: '写真論', author: 'ソンタグ' }],
            5: [{ title: '2030年の世界地図帳', author: '落合陽一' }, { title: 'デジタルネイチャー', author: '落合陽一' }],
            6: [{ title: 'いのちはのちのいのちへ', author: '稲葉俊郎' }],
            7: [{ title: '他者の苦痛へのまなざし', author: 'ソンタグ' }, { title: '夜と霧', author: 'フランクル' }],
            8: [{ title: '原爆詩集', author: '峠三吉' }, { title: 'ヒロシマ・ノート', author: '大江健三郎' }],
            9: [{ title: '愛するということ', author: 'フロム' }, { title: '暇と退屈の倫理学', author: '國分功一郎' }],
            10: [{ title: '生命とは何か', author: 'シュレーディンガー' }, { title: '生物から見た世界', author: 'ユクスキュル' }],
            11: [{ title: '贈与論', author: 'モース' }],
            12: [{ title: 'ツァラトゥストラ', author: 'ニーチェ' }, { title: '雪国', author: '川端康成' }]
        };

        // 5年計画の詳細データ
        const FIVE_YEAR_PLAN = {
            2026: {
                theme: '基盤構築', revenue: '1,500万',
                breakdown: { pxdt: '900万', hb: '100万', yohaku: '500万' },
                yohakuMonthly: '42万',
                quarters: [
                    { q: 'Q1', period: '1-3月', revenue: '20→30万', cumulative: '75万', events: 'コーチング資格研修開始' },
                    { q: 'Q2', period: '4-6月', revenue: '35→50万', cumulative: '200万', events: '乃木坂引越し、PxDT上期評価' },
                    { q: 'Q3', period: '7-9月', revenue: '50→60万', cumulative: '365万', events: 'コーチング資格取得' },
                    { q: 'Q4', period: '10-12月', revenue: '70→100万', cumulative: '500万', events: '写真展、スイス、PxDT下期評価' }
                ],
                smartGoals: {
                    business: [
                        { title: 'PxDT：昇格（6月評価）、年収900万円達成', details: ['上期評価でA評価を獲得する', '新規プロジェクト2件以上リード', '部門横断の改善提案を月1件以上', '週次1on1で進捗と課題を共有'] },
                        { title: 'HERALBONY：月額8万円安定、年間100万円', details: ['月2件の新規案件獲得', '既存クライアントのアップセル提案', 'ポートフォリオサイト更新（四半期ごと）', 'SNS発信を週3回継続'] },
                        { title: 'yohaku：12月に月商100万円達成', details: ['Q1: 20→30万（既存顧客深耕）', 'Q2: 35→50万（紹介経由の新規開拓）', 'Q3: 50→60万（コーチング開始）', 'Q4: 70→100万（高単価メニュー投入）'] },
                        { title: 'コーチング資格：9月取得', details: ['1-3月：研修プログラム受講開始', '4-6月：実践セッション50時間達成', '7-8月：認定試験対策', '9月：認定試験受験・合格'] }
                    ],
                    skill: [
                        { title: 'MBA科目：年間12科目修了', details: ['毎月1科目ペースで履修', '平日夜2時間を学習時間に確保', 'ケーススタディは週末にまとめて', '同期との勉強会を月1回開催'] },
                        { title: '読書：57冊（月4-5冊）', details: ['朝の15-20分を読書時間に固定', '月間読書計画を月初に立てる', '読んだ本は必ずメモを残す', 'ジャンルバランス：ビジネス2、教養2、文学1'] },
                        { title: '美術展：36回（月3回）', details: ['週末に1-2回の美術館訪問', '平日夜のギャラリー巡りを月1回', '感想をInstagramで発信', '気に入った作品は写真で記録'] }
                    ],
                    artist: [
                        { title: 'フィルム写真展：11月開催', details: ['1-3月：コンセプト・テーマ決定', '4-6月：撮影期間（週末中心）', '7-9月：セレクション・プリント制作', '10月：会場準備・DM作成', '11月：展示開催・在廊'] },
                        { title: 'ドラム：基礎習得、スタジオ練習週2回', details: ['基礎ルーディメンツ習得', 'メトロノーム練習を毎日15分', '週2回のスタジオ予約を固定', '月1回のレッスン受講'] }
                    ],
                    life: [
                        { title: '乃木坂引越し：4月', details: ['1-2月：物件探し・内見', '3月：契約・引越し準備', '4月：引越し実行・新生活スタート', '通勤時間短縮で生産性向上'] },
                        { title: '体重60kg維持', details: ['毎朝の体重測定・記録', '14時間ファスティング継続', '週3回の筋トレ（月水金）', '歩数8000歩/日を目標'] },
                        { title: 'スイス渡航：12月', details: ['航空券・宿泊の早期予約（6月）', '旅程プラン作成', '写真撮影計画（フィルム多めに）', '現地でしか見られないアートをリサーチ'] }
                    ]
                }
            },
            2027: {
                theme: '専門深化', revenue: '2,000万',
                breakdown: { pxdt: '1,100万', hb: '100万', yohaku: '800万' },
                yohakuMonthly: '67万',
                quarters: [
                    { q: 'Q1', period: '1-3月', revenue: '50→60万', cumulative: '165万', events: 'コーチング顧客5名体制' },
                    { q: 'Q2', period: '4-6月', revenue: '65→75万', cumulative: '375万', events: 'バイク免許取得、写真展企画' },
                    { q: 'Q3', period: '7-9月', revenue: '75→85万', cumulative: '615万', events: 'ドラム初ライブ、ヨーロッパ旅行' },
                    { q: 'Q4', period: '10-12月', revenue: '90→100万', cumulative: '800万', events: '写真展、yohaku App企画開始' }
                ],
                smartGoals: {
                    business: [
                        { title: 'PxDT：年収1,100万円', details: ['上半期・下半期ともにA評価維持', '新規事業領域でのリーダーシップ発揮', 'メンター制度でジュニア育成'] },
                        { title: 'yohaku：月商100万円安定化', details: ['リピート率80%以上を維持', '単価アップ施策の実施', 'サービスメニューの標準化'] },
                        { title: 'コーチング顧客：月5名継続', details: ['既存顧客からの紹介を促進', 'SNSでの発信強化', '成果事例のドキュメント化'] },
                        { title: '講演：年8回', details: ['業界カンファレンスへの登壇', '企業研修の講師依頼受諾', 'オンラインセミナー開催'] }
                    ],
                    skill: [
                        { title: 'MBA：全科目修了', details: ['残り科目を計画的に履修', '卒業論文のテーマ決定', '同期とのネットワーク強化'] },
                        { title: '読書：60冊', details: ['月5冊ペースを維持', '専門性の深い書籍にチャレンジ', '読書会への参加'] },
                        { title: '美術展：36回', details: ['国際アートフェア訪問', '海外の美術館を1つ以上訪問', 'アーティストとの交流'] }
                    ],
                    artist: [
                        { title: '写真展：第2回開催', details: ['新しいテーマでの挑戦', '前回より大きな会場で開催', 'アーティストコラボレーション'] },
                        { title: 'ドラム：初ライブ出演', details: ['バンドメンバー探し', '月2回のスタジオ練習', 'ライブハウスへの出演'] },
                        { title: 'ピアノ：基礎曲3曲習得', details: ['週1回のレッスン', '毎日15分の練習', '発表会への参加'] }
                    ],
                    life: [
                        { title: 'バイク免許：取得', details: ['教習所通い（3-4月）', '免許取得後のバイク選び', '安全運転講習受講'] },
                        { title: '海外旅行：ヨーロッパ', details: ['目的地：美術館巡り中心', '現地での写真撮影計画', '2週間程度の長期滞在'] }
                    ]
                }
            },
            2028: {
                theme: '事業拡大', revenue: '5,000万',
                breakdown: { pxdt: '1,300万', hb: '120万', yohaku: '3,580万' },
                yohakuMonthly: '300万',
                quarters: [
                    { q: 'Q1', period: '1-3月', revenue: '150→200万', cumulative: '525万', events: 'チームメンバー採用開始' },
                    { q: 'Q2', period: '4-6月', revenue: '220→270万', cumulative: '1,260万', events: 'yohaku Appβ版ローンチ' },
                    { q: 'Q3', period: '7-9月', revenue: '280→300万', cumulative: '2,130万', events: 'バンド活動本格化' },
                    { q: 'Q4', period: '10-12月', revenue: '310→330万', cumulative: '3,580万', events: '第3回写真展' }
                ],
                smartGoals: {
                    business: [
                        { title: 'yohaku：月商300万円達成', details: ['高単価サービスの拡充', 'リカーリング収益の構築', '法人向けサービス開始'] },
                        { title: 'yohaku App：ローンチ、MAU 1,000', details: ['β版フィードバック反映', 'マーケティング施策実行', 'ユーザーコミュニティ形成'] },
                        { title: 'チーム：2名採用', details: ['採用基準の明確化', '業務委託から正社員化検討', 'オンボーディング体制構築'] },
                        { title: 'ケア事業：BtoB研修10社導入', details: ['法人営業体制構築', '研修プログラム標準化', '成果測定の仕組み化'] }
                    ],
                    skill: [
                        { title: '講演：年20回', details: ['業界での認知拡大', '書籍出版の検討', 'メディア露出の増加'] }
                    ],
                    artist: [
                        { title: '写真展：第3回', details: ['シリーズとしてのブランド確立', '作品集の出版検討', '海外ギャラリーへのアプローチ'] },
                        { title: 'ドラム：バンド加入 or 結成', details: ['定期ライブ出演（月1回）', 'オリジナル曲制作', '音楽フェス出演を目標に'] }
                    ],
                    life: [
                        { title: 'バイク購入・ツーリング開始', details: ['愛車選び・購入', '月1回のツーリング計画', 'ライダー仲間との交流'] },
                        { title: '海外：3回', details: ['アジア・欧米・その他バランス', '写真撮影旅行として計画', '現地のアートシーン体験'] }
                    ]
                }
            },
            2029: {
                theme: '多角化', revenue: '7,000万',
                breakdown: { pxdt: '1,500万', hb: '120万', yohaku: '5,380万' },
                yohakuMonthly: '450万',
                quarters: [
                    { q: 'Q1', period: '1-3月', revenue: '350→400万', cumulative: '1,125万', events: 'チーム5名化' },
                    { q: 'Q2', period: '4-6月', revenue: '420→450万', cumulative: '2,430万', events: '海外市場調査' },
                    { q: 'Q3', period: '7-9月', revenue: '460→480万', cumulative: '3,840万', events: '自主企画ライブ' },
                    { q: 'Q4', period: '10-12月', revenue: '490→500万', cumulative: '5,380万', events: '第4回写真展（海外検討）' }
                ],
                smartGoals: {
                    business: [
                        { title: 'yohaku：月商500万円達成', details: ['サービス多角化', 'ストック収益50%以上', 'パートナー企業との連携'] },
                        { title: 'チーム：5名体制', details: ['コアメンバーの育成', '役割分担の最適化', '組織文化の醸成'] },
                        { title: 'yohaku App：MAU 5,000', details: ['機能拡充', 'プレミアムプラン導入', 'コミュニティ機能強化'] },
                        { title: 'ケア事業：SaaS化着手', details: ['MVP開発', 'パイロットユーザー獲得', 'プロダクトマーケットフィット検証'] }
                    ],
                    skill: [
                        { title: '講演：年30回（業界認知確立）', details: ['キーノートスピーカーとしての登壇', '書籍出版', 'メディア連載'] }
                    ],
                    artist: [
                        { title: '写真展：第4回（海外検討）', details: ['海外ギャラリーとの交渉', '国際的な写真賞への応募', '作品集の海外流通'] },
                        { title: 'ドラム：自主企画ライブ開催', details: ['企画・運営の経験', 'ゲストアーティスト招聘', 'ライブ映像制作'] }
                    ],
                    life: [
                        { title: 'バイクツーリング：国内制覇計画', details: ['47都道府県制覇開始', '長距離ツーリングスキル向上', '旅の記録ブログ'] },
                        { title: '海外：3回以上', details: ['ビジネス視察も兼ねた渡航', '写真撮影×観光×学び', '現地でのネットワーク構築'] }
                    ]
                }
            },
            2030: {
                theme: '統合', revenue: '1億',
                breakdown: { pxdt: '1,800万', hb: '120万', yohaku: '8,080万' },
                yohakuMonthly: '670万',
                quarters: [
                    { q: 'Q1', period: '1-3月', revenue: '550→600万', cumulative: '1,725万', events: '事業統合、効率化' },
                    { q: 'Q2', period: '4-6月', revenue: '620→670万', cumulative: '3,660万', events: '海外展開本格化' },
                    { q: 'Q3', period: '7-9月', revenue: '680→700万', cumulative: '5,730万', events: '音楽活動集大成' },
                    { q: 'Q4', period: '10-12月', revenue: '720→800万', cumulative: '8,080万', events: '第5回写真展、年収1億達成' }
                ],
                smartGoals: {
                    business: [
                        { title: 'yohaku：年商1億円達成', details: ['複数事業の安定収益化', 'M&A・事業提携の検討', '次世代経営体制の構築'] },
                        { title: 'チーム：10名体制', details: ['マネージャー層の育成', '採用・育成の仕組み化', '働きがいのある組織文化'] },
                        { title: 'yohaku App：MAU 20,000', details: ['グロース戦略の実行', '海外展開の検討', 'AI機能の強化'] },
                        { title: 'ケアSaaS：ARR 1,800万円', details: ['プロダクト成熟', 'カスタマーサクセス体制', '大手企業への導入'] }
                    ],
                    skill: [
                        { title: '業界での認知：ケア×テクノロジーの第一人者', details: ['業界団体での役職', 'メディア露出の常態化', '後進の育成・メンタリング'] }
                    ],
                    artist: [
                        { title: '写真展：第5回（5年連続達成）', details: ['5年間の集大成としての大規模展示', '回顧的な作品集出版', '次の5年のビジョン発表'] },
                        { title: '音楽：アルバム制作 or 定期ライブ', details: ['オリジナルアルバムのリリース', '定期的なライブ活動', '音楽と写真のコラボレーション'] }
                    ],
                    life: [
                        { title: '経済的自由の基盤確立', details: ['資産運用の安定化', '複数の収入源確保', '時間と場所の自由'] },
                        { title: '海外：4回以上', details: ['仕事と遊びの境界を超えた渡航', '長期滞在の検討', '国際的なネットワーク活用'] }
                    ]
                }
            }
        };

        const HEALTH_ITEMS = [
            { id: 'weight', label: '体重', icon: '⚖️', unit: 'kg', default: '60.0' },
            { id: 'sleep', label: '睡眠', icon: '😴', unit: '時間', default: '7.0' },
            { id: 'steps', label: '歩数', icon: '👟', unit: '歩', default: '8000' },
            { id: 'water', label: '水分', icon: '💧', unit: 'L', default: '2.0' }
        ];

        const DEFAULT_KEYWORDS = ['AI', '難聴', 'ヘラルボニー', 'アート', 'ピクシーダストテクノロジーズ', '認知症', 'HYDE', '難病', '紛争', 'ガザ地区', '政権', 'イスラエル', '戦争'];

        // ============================================
        // STATE
        // ============================================
        let currentDate = new Date();
        let calendarViewDate = new Date();
        let selectedGoalMonth = 1;
        let selectedPlanYear = 2026;
        let db = null;
        let newsKeywords = [...DEFAULT_KEYWORDS];
        let settings = { morningStart: '07:00', daytimeStart: '11:00', eveningStart: '20:00', nightStart: '22:00' };
        
        // 古いIDから新しいIDへのマッピング（データ移行用）
        const HABIT_ID_MIGRATION = {
            // 旧朝ルーティン → 新朝ルーティン
            'wake': 'water',           // 起床・白湯 → 水500ml
            'meditation': null,        // 瞑想（削除）
            'walk': 'morning_move',    // 朝散歩 → 軽運動
            'exercise': null,          // トレーニング（削除）
            'breakfast': null,         // 朝食（削除 - ファスティング）
            // 旧夜ルーティン → 新夕方/夜ルーティン
            'reading': null,           // 読書（削除）
            'study': null,             // MBA学習（削除）
            'journal': 'review',       // 日記 → 振り返り
            'night_meditation': 'reset' // 入浴 → リセット
        };

        // ============================================
        // THEME
        // ============================================
        let themeMode = 'auto'; // 'auto', 'light', 'dark'
        
        function updateTheme() {
            let isDark = false;
            
            if (themeMode === 'auto') {
                const hour = new Date().getHours();
                isDark = hour >= 18 || hour < 6;
            } else {
                isDark = themeMode === 'dark';
            }
            
            document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
            document.querySelector('meta[name="theme-color"]').content = isDark ? '#0d0d14' : '#faf9f7';
            
            // テーマ切り替えボタンの状態を更新
            updateThemeToggleUI();
        }
        
        function updateThemeToggleUI() {
            const buttons = document.querySelectorAll('.theme-toggle-btn');
            buttons.forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.theme === themeMode) {
                    btn.classList.add('active');
                }
            });
        }
        
        async function setThemeMode(mode) {
            themeMode = mode;
            await dbPut('settings', { id: 'themeMode', mode: mode });
            updateTheme();
            showToast(mode === 'auto' ? '自動テーマに設定' : mode === 'dark' ? 'ダークモードに設定' : 'ライトモードに設定');
        }
        
        async function loadThemeSettings() {
            const data = await dbGet('settings', 'themeMode');
            if (data?.mode) {
                themeMode = data.mode;
            }
            updateTheme();
        }

        // ============================================
        // IndexedDB
        // ============================================
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('YohakuDB', 5);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => { db = request.result; resolve(db); };
                request.onupgradeneeded = (e) => {
                    const database = e.target.result;
                    ['habits', 'goals', 'health', 'notes', 'books', 'images', 'customBooks', 'settings', 'keywords'].forEach(store => {
                        if (!database.objectStoreNames.contains(store)) {
                            database.createObjectStore(store, { keyPath: 'id', autoIncrement: store === 'customBooks' });
                        }
                    });
                };
            });
        }

        async function dbGet(store, key) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction([store], 'readonly');
                const req = tx.objectStore(store).get(key);
                req.onerror = () => reject(req.error);
                req.onsuccess = () => resolve(req.result);
            });
        }

        async function dbPut(store, data) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction([store], 'readwrite');
                const req = tx.objectStore(store).put(data);
                req.onerror = () => reject(req.error);
                req.onsuccess = () => resolve(req.result);
            });
        }

        async function dbGetAll(store) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction([store], 'readonly');
                const req = tx.objectStore(store).getAll();
                req.onerror = () => reject(req.error);
                req.onsuccess = () => resolve(req.result);
            });
        }
        
        // データマイグレーション: 古いIDのデータを新しいIDにコピー
        async function migrateHabitData() {
            const migrationDone = await dbGet('settings', 'migrationV2Done');
            if (migrationDone?.done) return; // 既にマイグレーション済み
            
            const allHabits = await dbGetAll('habits');
            for (const habit of allHabits) {
                // 古いIDを検出してマイグレーション
                for (const [oldId, newId] of Object.entries(HABIT_ID_MIGRATION)) {
                    if (newId && habit.id.includes(`-morning-${oldId}`) && habit.completed) {
                        const newKey = habit.id.replace(`-morning-${oldId}`, `-morning-${newId}`);
                        const existing = await dbGet('habits', newKey);
                        if (!existing) {
                            await dbPut('habits', { id: newKey, completed: true });
                        }
                    }
                    if (newId && habit.id.includes(`-evening-${oldId}`) && habit.completed) {
                        const newKey = habit.id.replace(`-evening-${oldId}`, `-evening-${newId}`);
                        const existing = await dbGet('habits', newKey);
                        if (!existing) {
                            await dbPut('habits', { id: newKey, completed: true });
                        }
                    }
                }
            }
            
            await dbPut('settings', { id: 'migrationV2Done', done: true, timestamp: new Date().toISOString() });
            console.log('データマイグレーション完了');
        }
        
        // 体重を前日から引き継ぐ
        async function getPreviousWeight() {
            // 過去7日間を探す
            for (let i = 1; i <= 7; i++) {
                const prevDate = new Date(currentDate);
                prevDate.setDate(prevDate.getDate() - i);
                const dateKey = formatDate(prevDate);
                const data = await dbGet('health', `${dateKey}-weight`);
                if (data?.value) {
                    return data.value;
                }
            }
            return '60.0'; // デフォルト値
        }

        // ============================================
        // UTILITIES
        // ============================================
        function formatDate(date) { return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`; }
        function getDateKey() { return formatDate(currentDate); }
        function getWeekday(date) { return ['日', '月', '火', '水', '木', '金', '土'][date.getDay()]; }
        function showToast(msg = '保存しました') { const t = document.getElementById('toast'); t.textContent = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 2000); }

        // SMART目標のアコーディオン開閉
        function toggleSmartGoal(id) {
            const item = document.getElementById('smart-' + id);
            if (item) {
                item.classList.toggle('open');
            }
        }

        function addMinutes(timeStr, minutes) {
            const [h, m] = timeStr.split(':').map(Number);
            const totalMinutes = h * 60 + m + minutes;
            const newH = Math.floor(totalMinutes / 60) % 24;
            const newM = totalMinutes % 60;
            return `${String(newH).padStart(2, '0')}:${String(newM).padStart(2, '0')}`;
        }
        
        function timeToMinutes(timeStr) { const [h, m] = timeStr.split(':').map(Number); return h * 60 + m; }
        
        function isInTimeRange(start, durationMinutes) {
            const now = new Date();
            const current = now.getHours() * 60 + now.getMinutes();
            const startM = timeToMinutes(start);
            const endM = startM + durationMinutes;
            return current >= startM && current <= endM;
        }

        // ============================================
        // TIME & PERIOD
        // ============================================
        function getTotalDuration(habits) {
            return habits.reduce((sum, h) => sum + h.duration, 0);
        }
        
        // 時間帯ごとの意識すべきこと
        const TIME_MINDSETS = {
            morning: {
                title: '💡 朝の意識',
                points: [
                    '水分をしっかり摂る（白湯 or レモン水）',
                    '最も集中力が高い時間 → 重要タスクを最優先',
                    'インプット時間：余白新聞・読書に集中',
                    '体を動かす：軽いストレッチで代謝UP'
                ],
                tip: '🎯 朝の1時間は夜の3時間に匹敵する。最重要タスクを先に。'
            },
            daytime: {
                title: '💡 日中の意識',
                points: [
                    '14時間ファスティング終了 → 最初の食事は腸に優しく',
                    'アウトプット時間：会議・創作・発信に注力',
                    '90分サイクルで休憩を入れる（ポモドーロ）',
                    '姿勢・呼吸を意識する（集中力維持）'
                ],
                tip: '🎯 「今日これだけは」を1つ決めて完遂する。'
            },
            evening: {
                title: '💡 夕方の意識',
                points: [
                    '21時までに最後の食事を終える',
                    '振り返りの時間：今日の成果と感謝を記録',
                    '明日の準備：TODOの整理と優先順位付け',
                    'デジタルデトックス開始の準備'
                ],
                tip: '🎯 今日1日で「できたこと」を3つ書き出す。'
            },
            night: {
                title: '⚠️ 判断禁止ゾーン',
                points: [
                    '重要な意思決定は明日に回す',
                    '食事・買い物・返信は控える',
                    'ブルーライトカット → 睡眠の質を守る',
                    'リラックスモード：読書・音楽・瞑想'
                ],
                tip: '🛑 夜の判断は後悔しやすい。疲れた脳で決めない。'
            }
        };

        // ファスティングタイマーの更新
        // 21:00から14時間（翌11:00まで）のファスティング
        function updateFastingTimer() {
            const now = new Date();
            const currentMinutes = now.getHours() * 60 + now.getMinutes();
            
            // 食事可能時間: 11:00〜21:00 (660分〜1260分)
            const eatingStart = 11 * 60; // 11:00
            const eatingEnd = 21 * 60;   // 21:00
            const fastingDuration = 14 * 60; // 14時間 = 840分
            const eatingDuration = 10 * 60;  // 10時間 = 600分
            
            const statusEl = document.getElementById('fastingStatus');
            const infoEl = document.getElementById('fastingInfo');
            const progressEl = document.getElementById('fastingProgressFill');
            const timerEl = document.getElementById('fastingTimer');
            
            if (currentMinutes >= eatingStart && currentMinutes < eatingEnd) {
                // 食事OK時間帯 (11:00〜21:00)
                const minutesUntilFasting = eatingEnd - currentMinutes;
                const hours = Math.floor(minutesUntilFasting / 60);
                const mins = minutesUntilFasting % 60;
                
                const elapsedEating = currentMinutes - eatingStart;
                const progressPercent = (elapsedEating / eatingDuration) * 100;
                
                statusEl.innerHTML = `<span style="color: var(--accent-sage);">🍽️ 食事OK</span>`;
                statusEl.className = 'fasting-status eating';
                
                if (minutesUntilFasting <= 60) {
                    infoEl.innerHTML = `⚠️ <strong>${mins}分後</strong>にファスティング開始`;
                    timerEl.style.borderColor = '#f97316';
                } else {
                    infoEl.innerHTML = `断食開始まで <strong>${hours}時間${mins}分</strong>`;
                    timerEl.style.borderColor = 'var(--accent-sage)';
                }
                
                progressEl.style.width = `${progressPercent}%`;
                progressEl.className = 'fasting-progress-fill eating';
                
            } else {
                // ファスティング時間帯 (21:00〜翌11:00)
                let minutesUntilEating;
                let elapsedFasting;
                
                if (currentMinutes >= eatingEnd) {
                    // 21:00以降（当日）
                    minutesUntilEating = (24 * 60 - currentMinutes) + eatingStart;
                    elapsedFasting = currentMinutes - eatingEnd;
                } else {
                    // 0:00〜11:00（翌日）
                    minutesUntilEating = eatingStart - currentMinutes;
                    elapsedFasting = (24 * 60 - eatingEnd) + currentMinutes;
                }
                
                const hours = Math.floor(minutesUntilEating / 60);
                const mins = minutesUntilEating % 60;
                const progressPercent = (elapsedFasting / fastingDuration) * 100;
                
                statusEl.innerHTML = `<span style="color: #f97316;">🔥 ファスティング中</span>
                    <div class="fasting-countdown">${hours}:${String(mins).padStart(2, '0')}</div>`;
                statusEl.className = 'fasting-status fasting';
                
                infoEl.innerHTML = `食事OK: <strong>11:00</strong>（${Math.round(progressPercent)}%達成）`;
                timerEl.style.borderColor = '#f97316';
                
                progressEl.style.width = `${Math.min(progressPercent, 100)}%`;
                progressEl.className = 'fasting-progress-fill';
            }
        }

        function updateDateTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            
            // ファスティングタイマー更新
            updateFastingTimer();
            
            const currentMinutes = now.getHours() * 60 + now.getMinutes();
            const morningStart = timeToMinutes(settings.morningStart);           // 7:00
            const daytimeStart = timeToMinutes(settings.daytimeStart || '11:00'); // 11:00
            const eveningStart = timeToMinutes(settings.eveningStart);            // 20:00
            const nightStart = timeToMinutes(settings.nightStart || '22:00');     // 22:00
            
            const periodEl = document.getElementById('timePeriod');
            const mindsetEl = document.getElementById('timeMindset');
            const morningSection = document.getElementById('morningSection');
            const daytimeSection = document.getElementById('daytimeSection');
            const eveningSection = document.getElementById('eveningSection');
            const nightSection = document.getElementById('nightSection');
            
            // リセット
            periodEl.className = 'time-period';
            periodEl.style.background = '';
            periodEl.style.color = '';
            morningSection.classList.remove('highlighted');
            daytimeSection.classList.remove('highlighted');
            daytimeSection.style.background = '';
            eveningSection.classList.remove('highlighted', 'evening');
            nightSection.classList.remove('highlighted');
            nightSection.style.background = '';
            
            let currentMindset = null;
            
            if (currentMinutes >= morningStart && currentMinutes < daytimeStart) {
                periodEl.textContent = '🌅 朝のルーティン（ファスティング中）';
                periodEl.classList.add('morning');
                morningSection.classList.add('highlighted');
                currentMindset = TIME_MINDSETS.morning;
                mindsetEl.style.borderColor = 'var(--accent-gold)';
            } else if (currentMinutes >= daytimeStart && currentMinutes < eveningStart) {
                periodEl.textContent = '☀️ 日中（食事OK 11:00-21:00）';
                periodEl.style.background = 'var(--accent-sage-dim)';
                periodEl.style.color = 'var(--accent-sage)';
                daytimeSection.classList.add('highlighted');
                daytimeSection.style.background = 'var(--accent-sage-dim)';
                currentMindset = TIME_MINDSETS.daytime;
                mindsetEl.style.borderColor = 'var(--accent-sage)';
            } else if (currentMinutes >= eveningStart && currentMinutes < nightStart) {
                periodEl.textContent = '🌆 夕方（夕食は21時まで）';
                periodEl.classList.add('evening');
                eveningSection.classList.add('highlighted', 'evening');
                currentMindset = TIME_MINDSETS.evening;
                mindsetEl.style.borderColor = 'var(--accent-blue)';
            } else if (currentMinutes >= nightStart || currentMinutes < morningStart) {
                periodEl.textContent = '🌙 判断禁止ゾーン（ノンカロリーのみ）';
                periodEl.style.background = 'rgba(139, 92, 246, 0.15)';
                periodEl.style.color = '#8b5cf6';
                nightSection.classList.add('highlighted');
                nightSection.style.background = 'rgba(139, 92, 246, 0.15)';
                currentMindset = TIME_MINDSETS.night;
                mindsetEl.style.borderColor = '#8b5cf6';
            }
            
            // 意識すべきことを更新
            if (currentMindset) {
                mindsetEl.innerHTML = `
                    <div class="time-mindset-title">${currentMindset.title}</div>
                    <ul class="time-mindset-list">
                        ${currentMindset.points.map(p => `<li>${p}</li>`).join('')}
                    </ul>
                    <div class="time-mindset-tip">${currentMindset.tip}</div>
                `;
            }
            
            updateTheme();
        }

        function updateTimeRangeDisplay() {
            document.getElementById('morningTimeBadge').textContent = `${settings.morningStart}〜`;
            document.getElementById('daytimeTimeBadge').textContent = `${settings.daytimeStart || '12:00'}〜`;
            document.getElementById('eveningTimeBadge').textContent = `${settings.eveningStart}〜`;
            document.getElementById('nightTimeBadge').textContent = `${settings.nightStart || '22:00'}〜`;
        }

        // ============================================
        // RENDER FUNCTIONS
        // ============================================
        function updateDateDisplay() {
            document.querySelector('#currentDate .date-text').textContent = `${currentDate.getMonth() + 1}月${currentDate.getDate()}日`;
            document.querySelector('#currentDate .weekday').textContent = getWeekday(currentDate);
        }

        function updateQuote() {
            const dayOfYear = Math.floor((currentDate - new Date(currentDate.getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
            document.getElementById('dailyQuote').textContent = QUOTES[dayOfYear % QUOTES.length];
        }

        function updateMonthCard() {
            const month = currentDate.getMonth() + 1;
            const data = MONTHS[month];
            document.getElementById('monthTheme').textContent = data.theme;
            document.getElementById('monthQuote').textContent = data.quote;
        }

        async function renderHabits(habits, containerId, period, progressId, startTime) {
            const container = document.getElementById(containerId);
            const dateKey = getDateKey();
            let completed = 0;
            let currentTime = startTime;
            container.innerHTML = '';
            
            for (const habit of habits) {
                const key = `${dateKey}-${period}-${habit.id}`;
                const data = await dbGet('habits', key);
                const isCompleted = data?.completed || false;
                if (isCompleted) completed++;
                
                const timeDisplay = currentTime;
                currentTime = addMinutes(currentTime, habit.duration);
                
                const item = document.createElement('div');
                item.className = `habit-item ${isCompleted ? 'completed' : ''}`;
                item.onclick = () => toggleHabit(period, habit.id);
                item.innerHTML = `
                    <div class="habit-checkbox"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg></div>
                    <div class="habit-info">
                        <div class="habit-name">${habit.name}</div>
                        <div class="habit-time">${timeDisplay}〜（${habit.duration}分）</div>
                    </div>`;
                container.appendChild(item);
            }
            document.getElementById(progressId).textContent = `${completed}/${habits.length}`;
        }

        async function renderMorningHabits() { await renderHabits(MORNING_HABITS, 'morningHabits', 'morning', 'morningProgress', settings.morningStart); }
        async function renderDaytimeHabits() { await renderHabits(DAYTIME_HABITS, 'daytimeHabits', 'daytime', 'daytimeProgress', settings.daytimeStart || '12:00'); }
        async function renderEveningHabits() { await renderHabits(EVENING_HABITS, 'eveningHabits', 'evening', 'eveningProgress', settings.eveningStart); }
        async function renderNightHabits() { await renderHabits(NIGHT_HABITS, 'nightHabits', 'night', 'nightProgress', settings.nightStart || '22:00'); }
        
        async function renderStrengthHabits() {
            const container = document.getElementById('strengthHabits');
            const dateKey = getDateKey();
            const dayOfWeek = currentDate.getDay();
            const isStrengthDay = [1, 3, 5].includes(dayOfWeek); // 月・水・金
            
            // 筋トレ日でなければセクションを非表示
            const section = document.getElementById('strengthSection');
            if (!isStrengthDay) {
                section.style.display = 'none';
                return;
            }
            section.style.display = 'block';
            
            let completed = 0;
            container.innerHTML = '';
            
            for (const habit of STRENGTH_HABITS) {
                const key = `${dateKey}-strength-${habit.id}`;
                const data = await dbGet('habits', key);
                const isCompleted = data?.completed || false;
                if (isCompleted) completed++;
                
                const item = document.createElement('div');
                item.className = `habit-item ${isCompleted ? 'completed' : ''}`;
                item.onclick = () => toggleStrengthHabit(habit.id);
                item.innerHTML = `
                    <div class="habit-checkbox"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg></div>
                    <div class="habit-info">
                        <div class="habit-name">${habit.name}</div>
                        <div class="habit-time">約${habit.duration}分</div>
                    </div>`;
                container.appendChild(item);
            }
            document.getElementById('strengthProgress').textContent = `${completed}/${STRENGTH_HABITS.length}`;
        }
        
        async function toggleStrengthHabit(habitId) {
            const key = `${getDateKey()}-strength-${habitId}`;
            const data = await dbGet('habits', key);
            const newValue = !(data?.completed || false);
            await dbPut('habits', { id: key, completed: newValue });
            renderStrengthHabits();
            renderStats();
            showToast(newValue ? '完了！' : '取り消しました');
        }

        async function renderHealthGrid() {
            const container = document.getElementById('healthGrid');
            const dateKey = getDateKey();
            container.innerHTML = '';
            for (const item of HEALTH_ITEMS) {
                const data = await dbGet('health', `${dateKey}-${item.id}`);
                let value = data?.value;
                
                // 体重は前日から引き継ぐ（今日の値がない場合）
                if (!value && item.id === 'weight') {
                    value = await getPreviousWeight();
                }
                value = value || item.default;
                
                const div = document.createElement('div');
                div.className = 'health-item';
                div.innerHTML = `<div class="health-icon">${item.icon}</div><div class="health-label">${item.label}</div><div class="health-value"><input type="number" step="0.1" value="${value}" onchange="updateHealth('${item.id}', this.value)" onclick="this.select()"><span class="health-unit">${item.unit}</span></div>`;
                container.appendChild(div);
            }
        }

        async function renderDailyNote() {
            const data = await dbGet('notes', getDateKey());
            document.getElementById('dailyNote').value = data?.text || '';
        }

        async function renderUploadedImages() {
            const container = document.getElementById('uploadedImages');
            const data = await dbGet('images', getDateKey());
            const images = data?.images || [];
            container.innerHTML = images.map((img, i) => `<div class="uploaded-image"><img src="${img}" alt=""><button class="remove-btn" onclick="removeImage(${i})"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg></button></div>`).join('');
        }

        // ============================================
        // NEWS FUNCTIONS
        // ============================================
        async function loadKeywords() {
            const data = await dbGet('keywords', 'userKeywords');
            if (data?.keywords?.length) newsKeywords = data.keywords;
            else newsKeywords = [...DEFAULT_KEYWORDS];
        }

        async function saveKeywords() {
            await dbPut('keywords', { id: 'userKeywords', keywords: newsKeywords });
        }

        function renderKeywordTags() {
            const container = document.getElementById('keywordTags');
            container.innerHTML = newsKeywords.map((kw, i) => `<div class="keyword-tag"><span>${kw}</span><span class="remove" onclick="event.stopPropagation(); removeKeyword(${i})">×</span></div>`).join('') + '<button class="add-keyword-btn" onclick="openAddKeywordModal()">+ 追加</button>';
        }

        function renderNews() {
            const container = document.getElementById('newsContainer');
            container.innerHTML = newsKeywords.map(kw => {
                const searchUrl = `https://news.google.com/search?q=${encodeURIComponent(kw)}&hl=ja&gl=JP&ceid=JP:ja`;
                return `
                    <div class="news-card">
                        <div class="news-card-header">
                            <span class="news-keyword">${kw}</span>
                            <a href="${searchUrl}" target="_blank" class="news-link-btn">Google Newsで開く →</a>
                        </div>
                        <div class="news-list">
                            <div class="news-item" onclick="window.open('${searchUrl}', '_blank')">
                                <div class="news-item-title">「${kw}」の最新ニュースを見る</div>
                                <div class="news-item-meta">
                                    <span class="news-item-source">Google News</span>
                                    <span class="news-item-date">タップして開く</span>
                                </div>
                            </div>
                        </div>
                    </div>`;
            }).join('');
        }

        function openAddKeywordModal() { document.getElementById('addKeywordModal').classList.add('active'); document.getElementById('keywordInput').value = ''; }
        function closeAddKeywordModal() { document.getElementById('addKeywordModal').classList.remove('active'); }

        async function addKeyword() {
            const input = document.getElementById('keywordInput').value.trim();
            if (!input) return;
            if (!newsKeywords.includes(input)) {
                newsKeywords.push(input);
                await saveKeywords();
                renderKeywordTags();
                renderNews();
            }
            closeAddKeywordModal();
            showToast('キーワードを追加しました');
        }

        async function removeKeyword(index) {
            newsKeywords.splice(index, 1);
            await saveKeywords();
            renderKeywordTags();
            renderNews();
            showToast('キーワードを削除しました');
        }

        // ============================================
        // WEEK VIEW
        // ============================================
        async function renderWeekCalendar() {
            const container = document.getElementById('weekCalendar');
            container.innerHTML = '';
            const startOfWeek = new Date(currentDate);
            startOfWeek.setDate(currentDate.getDate() - currentDate.getDay());
            for (let i = 0; i < 7; i++) {
                const date = new Date(startOfWeek);
                date.setDate(startOfWeek.getDate() + i);
                const dateKey = formatDate(date);
                const isActive = dateKey === formatDate(currentDate);
                let completed = 0;
                const total = MORNING_HABITS.length + DAYTIME_HABITS.length + EVENING_HABITS.length + NIGHT_HABITS.length;
                for (const h of MORNING_HABITS) { if ((await dbGet('habits', `${dateKey}-morning-${h.id}`))?.completed) completed++; }
                for (const h of DAYTIME_HABITS) { if ((await dbGet('habits', `${dateKey}-daytime-${h.id}`))?.completed) completed++; }
                for (const h of EVENING_HABITS) { if ((await dbGet('habits', `${dateKey}-evening-${h.id}`))?.completed) completed++; }
                for (const h of NIGHT_HABITS) { if ((await dbGet('habits', `${dateKey}-night-${h.id}`))?.completed) completed++; }
                const div = document.createElement('div');
                div.className = `week-day ${isActive ? 'active' : ''}`;
                div.onclick = () => { currentDate = new Date(date); renderAll(); };
                div.innerHTML = `<div class="week-day-name">${getWeekday(date)}</div><div class="week-day-num">${date.getDate()}</div><div class="week-day-progress"><div class="week-day-progress-bar" style="width: ${total > 0 ? (completed / total) * 100 : 0}%"></div></div>`;
                container.appendChild(div);
            }
        }

        function renderWeeklyActivities() {
            const container = document.getElementById('weeklyActivities');
            const today = getWeekday(currentDate);
            const isWeekend = today === '土' || today === '日';
            container.innerHTML = WEEKLY_ACTIVITIES.map(a => {
                let isToday = a.day.includes(today);
                if (a.id === 'film' && isWeekend) isToday = true;
                if (a.id === 'art' && isWeekend) isToday = true;
                return `<div class="activity-item"><div class="activity-info"><span class="activity-icon">${a.icon}</span><div><div class="activity-name">${a.name}</div><div class="activity-day">${a.day}</div></div></div><span class="activity-status ${isToday ? 'scheduled' : ''}">${isToday ? '今日' : '予定'}</span></div>`;
            }).join('');
        }

        async function renderBookList() {
            const container = document.getElementById('bookList');
            const month = currentDate.getMonth() + 1;
            const books = MONTHLY_BOOKS[month] || [];
            container.innerHTML = '';
            let completed = 0;
            for (const book of books) {
                const key = `book-${month}-${book.title}`;
                const data = await dbGet('books', key);
                const isCompleted = data?.completed || false;
                if (isCompleted) completed++;
                const div = document.createElement('div');
                div.className = `book-item ${isCompleted ? 'completed' : ''}`;
                div.onclick = () => toggleBook(month, book.title);
                div.innerHTML = `<div class="book-checkbox"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg></div><div class="book-info"><div class="book-title">${book.title}</div><div class="book-author">${book.author}</div></div>`;
                container.appendChild(div);
            }
            const customBooks = (await dbGetAll('customBooks')).filter(b => b.month === month);
            for (const book of customBooks) {
                if (book.completed) completed++;
                const div = document.createElement('div');
                div.className = `book-item ${book.completed ? 'completed' : ''}`;
                div.onclick = () => toggleCustomBook(book.id);
                div.innerHTML = `<div class="book-checkbox"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg></div><div class="book-info"><div class="book-title">${book.title}</div><div class="book-author">${book.author}</div></div>`;
                container.appendChild(div);
            }
            document.getElementById('bookProgress').textContent = `${completed}/${books.length + customBooks.length}`;
        }

        // ============================================
        // GOALS
        // ============================================
        async function renderYearGoals() {
            const container = document.getElementById('yearGoals');
            container.innerHTML = '';
            for (let i = 0; i < YEAR_GOALS.length; i++) {
                const goal = YEAR_GOALS[i];
                const data = await dbGet('goals', `year-goal-${i}`);
                const isCompleted = data?.completed || false;
                const div = document.createElement('div');
                div.className = `goal-card ${isCompleted ? 'completed' : ''}`;
                div.onclick = () => toggleYearGoal(i);
                div.innerHTML = `<div class="goal-header"><div class="goal-checkbox"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg></div><div class="goal-content"><div class="goal-title">${goal.text}</div><div class="goal-deadline">${goal.deadline}</div></div></div>`;
                container.appendChild(div);
            }
        }

        function renderMonthTabs() {
            const container = document.getElementById('monthTabs');
            container.innerHTML = '';
            for (let m = 1; m <= 12; m++) {
                const tab = document.createElement('button');
                tab.className = `month-tab ${m === selectedGoalMonth ? 'active' : ''}`;
                tab.textContent = `${m}月`;
                tab.onclick = () => { selectedGoalMonth = m; renderMonthTabs(); renderMonthGoals(); };
                container.appendChild(tab);
            }
        }

        async function renderMonthGoals() {
            const container = document.getElementById('monthGoals');
            const data = MONTHS[selectedGoalMonth];
            document.getElementById('monthGoalsTitle').textContent = `${selectedGoalMonth}月の目標`;
            container.innerHTML = '';
            for (let i = 0; i < data.goals.length; i++) {
                const goalData = await dbGet('goals', `month-${selectedGoalMonth}-goal-${i}`);
                const isCompleted = goalData?.completed || false;
                const div = document.createElement('div');
                div.className = `goal-card ${isCompleted ? 'completed' : ''}`;
                div.onclick = () => toggleMonthGoal(selectedGoalMonth, i);
                div.innerHTML = `<div class="goal-header"><div class="goal-checkbox"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg></div><div class="goal-content"><div class="goal-title">${data.goals[i]}</div></div></div>`;
                container.appendChild(div);
            }
        }

        // ============================================
        // FIVE YEAR PLAN
        // ============================================
        function renderPlanTabs() {
            const container = document.getElementById('planTabs');
            container.innerHTML = [2026, 2027, 2028, 2029, 2030].map(year => 
                `<button class="plan-tab ${year === selectedPlanYear ? 'active' : ''}" onclick="selectPlanYear(${year})">${year}</button>`
            ).join('');
        }

        function selectPlanYear(year) {
            selectedPlanYear = year;
            renderPlanTabs();
            renderFiveYearPlan();
        }

        function renderFiveYearPlan() {
            const container = document.getElementById('fiveYearPlan');
            const y = FIVE_YEAR_PLAN[selectedPlanYear];
            const isCurrent = selectedPlanYear === 2026;
            
            container.innerHTML = `
                <div class="plan-year-card ${isCurrent ? 'current' : ''}">
                    <div class="plan-year-header">
                        <div>
                            <div class="plan-year">${selectedPlanYear}</div>
                            <div class="plan-year-theme">${y.theme}</div>
                        </div>
                        <div class="plan-year-revenue">
                            <div class="plan-year-revenue-label">年収目標</div>
                            <div class="plan-year-revenue-value">¥${y.revenue}</div>
                        </div>
                    </div>
                    <div class="plan-breakdown">
                        <div class="plan-breakdown-item"><div class="plan-breakdown-label">PxDT</div><div class="plan-breakdown-value">¥${y.breakdown.pxdt}</div></div>
                        <div class="plan-breakdown-item"><div class="plan-breakdown-label">HB</div><div class="plan-breakdown-value">¥${y.breakdown.hb}</div></div>
                        <div class="plan-breakdown-item"><div class="plan-breakdown-label">yohaku</div><div class="plan-breakdown-value">¥${y.breakdown.yohaku}</div></div>
                    </div>
                    <div style="text-align: center; padding: 12px; background: var(--accent-gold-dim); border-radius: var(--radius-md); margin-bottom: 16px;">
                        <div style="font-size: 11px; color: var(--text-muted);">yohaku月商平均</div>
                        <div style="font-family: var(--font-display); font-size: 28px; color: var(--accent-gold);">¥${y.yohakuMonthly}</div>
                    </div>
                </div>
                
                <div class="section-title" style="margin: 20px 0 12px;">四半期マイルストーン</div>
                ${y.quarters.map(q => `
                    <div class="plan-quarter">
                        <div class="plan-quarter-header">
                            <span class="plan-quarter-name">${q.q}（${q.period}）</span>
                            <span class="plan-quarter-revenue">¥${q.revenue}</span>
                        </div>
                        <div class="plan-quarter-events">${q.events}</div>
                        <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">累計: ¥${q.cumulative}</div>
                    </div>
                `).join('')}
                
                <div class="section-title" style="margin: 20px 0 12px;">SMART目標 <span style="font-size: 11px; color: var(--text-muted); font-weight: normal;">（タップで詳細表示）</span></div>
                <div class="plan-year-card">
                    ${Object.entries(y.smartGoals).map(([category, goals]) => `
                        <div class="plan-section" style="margin-top: 0; padding-top: 0; border-top: none;">
                            <div class="plan-section-title">${{business: '💼 事業・キャリア', skill: '📚 スキル・学習', artist: '🎨 アーティスト活動', life: '🌱 生活'}[category]}</div>
                            <div class="plan-milestones">
                                ${goals.map((g, idx) => {
                                    const title = typeof g === 'string' ? g : g.title;
                                    const details = typeof g === 'string' ? [] : (g.details || []);
                                    const uniqueId = category + '-' + idx;
                                    return `
                                        <div class="smart-goal-item" id="smart-${uniqueId}">
                                            <div class="smart-goal-header" onclick="toggleSmartGoal('${uniqueId}')">
                                                <div class="smart-goal-dot"></div>
                                                <div class="smart-goal-title">${title}</div>
                                                ${details.length > 0 ? `
                                                    <div class="smart-goal-toggle">
                                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                            <polyline points="6 9 12 15 18 9"/>
                                                        </svg>
                                                    </div>
                                                ` : ''}
                                            </div>
                                            ${details.length > 0 ? `
                                                <div class="smart-goal-details">
                                                    <div class="smart-goal-details-inner">
                                                        <ul class="smart-goal-details-list">
                                                            ${details.map(d => '<li>' + d + '</li>').join('')}
                                                        </ul>
                                                    </div>
                                                </div>
                                            ` : ''}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        async function renderStats() {
            // 7割達成をカウント
            let streak = 0;
            let checkDate = new Date();
            const allHabits = [...MORNING_HABITS, ...DAYTIME_HABITS, ...EVENING_HABITS, ...NIGHT_HABITS];
            const requiredCompletion = Math.floor(allHabits.length * 0.7);
            
            while (streak < 365) {
                const dateKey = formatDate(checkDate);
                let completedCount = 0;
                
                for (const h of MORNING_HABITS) {
                    if ((await dbGet('habits', `${dateKey}-morning-${h.id}`))?.completed) completedCount++;
                }
                for (const h of DAYTIME_HABITS) {
                    if ((await dbGet('habits', `${dateKey}-daytime-${h.id}`))?.completed) completedCount++;
                }
                for (const h of EVENING_HABITS) {
                    if ((await dbGet('habits', `${dateKey}-evening-${h.id}`))?.completed) completedCount++;
                }
                for (const h of NIGHT_HABITS) {
                    if ((await dbGet('habits', `${dateKey}-night-${h.id}`))?.completed) completedCount++;
                }
                
                if (completedCount >= requiredCompletion) { 
                    streak++; 
                    checkDate.setDate(checkDate.getDate() - 1); 
                } else break;
            }
            document.getElementById('totalStreak').textContent = streak;
            document.getElementById('totalHabits').textContent = (await dbGetAll('habits')).filter(h => h.completed).length;
            document.getElementById('totalGoals').textContent = (await dbGetAll('goals')).filter(g => g.completed).length;
            document.getElementById('totalBooks').textContent = (await dbGetAll('books')).filter(b => b.completed).length + (await dbGetAll('customBooks')).filter(b => b.completed).length;
        }

        // ============================================
        // WEEKLY REPORT
        // ============================================
        async function generateWeeklyReport() {
            const contentEl = document.getElementById('weeklyReportContent');
            const btn = document.querySelector('.weekly-report-btn');
            
            btn.disabled = true;
            btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: spin 1s linear infinite;"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg> 集計中...';
            contentEl.innerHTML = '<div class="weekly-report-placeholder"><p>データを集計しています...</p></div>';
            
            try {
                const today = new Date();
                const weekData = [];
                const allHabits = [...MORNING_HABITS, ...DAYTIME_HABITS, ...EVENING_HABITS, ...NIGHT_HABITS];
                const totalHabitCount = allHabits.length;
                
                // 過去7日間のデータを集計
                for (let i = 6; i >= 0; i--) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - i);
                    const dateKey = formatDate(date);
                    
                    // 習慣達成数
                    let completedHabits = 0;
                    for (const h of MORNING_HABITS) {
                        if ((await dbGet('habits', `${dateKey}-morning-${h.id}`))?.completed) completedHabits++;
                    }
                    for (const h of DAYTIME_HABITS) {
                        if ((await dbGet('habits', `${dateKey}-daytime-${h.id}`))?.completed) completedHabits++;
                    }
                    for (const h of EVENING_HABITS) {
                        if ((await dbGet('habits', `${dateKey}-evening-${h.id}`))?.completed) completedHabits++;
                    }
                    for (const h of NIGHT_HABITS) {
                        if ((await dbGet('habits', `${dateKey}-night-${h.id}`))?.completed) completedHabits++;
                    }
                    
                    // 体重
                    const weightData = await dbGet('health', `${dateKey}-weight`);
                    const weight = weightData?.value ? parseFloat(weightData.value) : null;
                    
                    weekData.push({
                        date,
                        dateKey,
                        dayLabel: ['日', '月', '火', '水', '木', '金', '土'][date.getDay()],
                        completedHabits,
                        achievementRate: Math.round((completedHabits / totalHabitCount) * 100),
                        weight
                    });
                }
                
                // 統計計算
                const avgAchievement = Math.round(weekData.reduce((sum, d) => sum + d.achievementRate, 0) / 7);
                const perfectDays = weekData.filter(d => d.achievementRate >= 70).length;
                
                // 体重推移
                const weightsWithData = weekData.filter(d => d.weight !== null);
                const startWeight = weightsWithData.length > 0 ? weightsWithData[0].weight : null;
                const endWeight = weightsWithData.length > 0 ? weightsWithData[weightsWithData.length - 1].weight : null;
                const weightChange = startWeight && endWeight ? (endWeight - startWeight).toFixed(1) : null;
                
                // 読んだ本の数（今週）
                const weekStart = new Date(today);
                weekStart.setDate(weekStart.getDate() - 6);
                const allBooks = [...(await dbGetAll('books')), ...(await dbGetAll('customBooks'))];
                const booksThisWeek = allBooks.filter(b => b.completed).length; // 簡易版
                
                // HTML生成
                let html = `
                    <div class="weekly-stats-row">
                        <div class="weekly-stat-item">
                            <div class="weekly-stat-value">${avgAchievement}%</div>
                            <div class="weekly-stat-label">平均達成率</div>
                        </div>
                        <div class="weekly-stat-item">
                            <div class="weekly-stat-value">${perfectDays}/7</div>
                            <div class="weekly-stat-label">7割達成日</div>
                        </div>
                        <div class="weekly-stat-item">
                            <div class="weekly-stat-value">${booksThisWeek}</div>
                            <div class="weekly-stat-label">読了した本</div>
                        </div>
                    </div>
                `;
                
                // 体重推移
                if (startWeight && endWeight) {
                    const changeClass = parseFloat(weightChange) < 0 ? 'positive' : parseFloat(weightChange) > 0 ? 'negative' : '';
                    const changeIcon = parseFloat(weightChange) < 0 ? '↓' : parseFloat(weightChange) > 0 ? '↑' : '→';
                    html += `
                        <div class="weekly-weight-trend">
                            <div class="weekly-weight-item">
                                <div class="weekly-weight-label">週初め</div>
                                <div class="weekly-weight-value">${startWeight}kg</div>
                            </div>
                            <div class="weekly-weight-arrow">→</div>
                            <div class="weekly-weight-item">
                                <div class="weekly-weight-label">現在</div>
                                <div class="weekly-weight-value">${endWeight}kg</div>
                            </div>
                            <div class="weekly-weight-item">
                                <div class="weekly-weight-label">変化</div>
                                <div class="weekly-weight-value ${changeClass}">${changeIcon}${Math.abs(weightChange)}kg</div>
                            </div>
                        </div>
                    `;
                }
                
                // 習慣達成率チャート
                html += `
                    <div class="weekly-chart">
                        <div class="weekly-chart-title">📈 日別習慣達成率</div>
                        <div class="weekly-chart-bars">
                            ${weekData.map(d => `
                                <div class="weekly-chart-bar-container">
                                    <div class="weekly-chart-value">${d.achievementRate}%</div>
                                    <div class="weekly-chart-bar" style="height: ${Math.max(d.achievementRate * 0.7, 4)}px;"></div>
                                    <div class="weekly-chart-label">${d.dayLabel}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                
                // AIコメント生成（APIキーがあれば）
                const openaiKeyData = await dbGet('settings', 'openaiApiKey');
                if (openaiKeyData?.key) {
                    html += `<div class="weekly-ai-comment" id="weeklyAiComment">
                        <div class="weekly-ai-comment-title">🤖 AIからのフィードバック</div>
                        <div class="weekly-ai-comment-text">分析中...</div>
                    </div>`;
                    contentEl.innerHTML = html;
                    
                    // AIコメント生成
                    try {
                        const aiComment = await generateWeeklyAIComment(openaiKeyData.key, weekData, avgAchievement, weightChange);
                        document.querySelector('#weeklyAiComment .weekly-ai-comment-text').textContent = aiComment;
                    } catch (e) {
                        document.querySelector('#weeklyAiComment .weekly-ai-comment-text').textContent = 
                            `今週の平均達成率は${avgAchievement}%でした。${perfectDays >= 5 ? '素晴らしい継続力です！' : '来週も一緒に頑張りましょう！'}`;
                    }
                } else {
                    // AIなしの簡易コメント
                    const comment = avgAchievement >= 80 ? '素晴らしい1週間でした！この調子で継続しましょう。' :
                                   avgAchievement >= 60 ? '良いペースです。少しずつ習慣が定着してきていますね。' :
                                   '来週はもう少し意識してみましょう。小さな一歩が大切です。';
                    html += `
                        <div class="weekly-ai-comment">
                            <div class="weekly-ai-comment-title">💬 今週のまとめ</div>
                            <div class="weekly-ai-comment-text">${comment}</div>
                        </div>
                    `;
                    contentEl.innerHTML = html;
                }
                
            } catch (error) {
                console.error('週間レポート生成エラー:', error);
                contentEl.innerHTML = `<div class="weekly-report-placeholder"><p>エラーが発生しました: ${error.message}</p></div>`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg> レポート生成';
            }
        }
        
        async function generateWeeklyAIComment(apiKey, weekData, avgAchievement, weightChange) {
            const prompt = `あなたは習慣コーチです。以下の1週間の習慣達成データを分析し、励ましと具体的なアドバイスを2-3文で簡潔に伝えてください。

データ:
- 平均達成率: ${avgAchievement}%
- 日別達成率: ${weekData.map(d => `${d.dayLabel}:${d.achievementRate}%`).join(', ')}
- 7割達成日: ${weekData.filter(d => d.achievementRate >= 70).length}日
${weightChange ? `- 体重変化: ${weightChange > 0 ? '+' : ''}${weightChange}kg` : ''}

ポイント:
- ポジティブな点を見つけて褒める
- 具体的な改善ポイントを1つだけ提案
- 絵文字は使わない
- 敬語で丁寧に`;

            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: 'gpt-4o-mini',
                    messages: [{ role: 'user', content: prompt }],
                    max_tokens: 200,
                    temperature: 0.7
                })
            });
            
            if (!response.ok) throw new Error('AI生成に失敗しました');
            const data = await response.json();
            return data.choices[0].message.content.trim();
        }

        // ============================================
        // EVENT HANDLERS
        // ============================================
        async function toggleHabit(period, habitId) {
            const key = `${getDateKey()}-${period}-${habitId}`;
            const data = await dbGet('habits', key);
            const newValue = !(data?.completed || false);
            await dbPut('habits', { id: key, completed: newValue });
            
            // 該当する習慣セクションを再描画
            switch (period) {
                case 'morning': await renderMorningHabits(); break;
                case 'daytime': await renderDaytimeHabits(); break;
                case 'evening': await renderEveningHabits(); break;
                case 'night': await renderNightHabits(); break;
            }
            renderStats();
            showToast(newValue ? '完了！' : '取り消しました');
        }

        async function updateHealth(id, value) {
            await dbPut('health', { id: `${getDateKey()}-${id}`, value });
            showToast();
        }

        async function toggleBook(month, title) {
            const key = `book-${month}-${title}`;
            const data = await dbGet('books', key);
            await dbPut('books', { id: key, completed: !(data?.completed || false) });
            renderBookList(); renderStats();
            showToast(!(data?.completed) ? '読了！' : '取り消しました');
        }

        async function toggleCustomBook(id) {
            const book = await dbGet('customBooks', id);
            if (book) { book.completed = !book.completed; await dbPut('customBooks', book); renderBookList(); renderStats(); showToast(book.completed ? '読了！' : '取り消しました'); }
        }

        async function toggleYearGoal(index) {
            const key = `year-goal-${index}`;
            const data = await dbGet('goals', key);
            await dbPut('goals', { id: key, completed: !(data?.completed || false) });
            renderYearGoals(); renderStats();
            showToast(!(data?.completed) ? '達成！' : '取り消しました');
        }

        async function toggleMonthGoal(month, index) {
            const key = `month-${month}-goal-${index}`;
            const data = await dbGet('goals', key);
            await dbPut('goals', { id: key, completed: !(data?.completed || false) });
            renderMonthGoals(); renderStats();
            showToast(!(data?.completed) ? '達成！' : '取り消しました');
        }

        // Calendar
        function openCalendar() { calendarViewDate = new Date(currentDate); renderCalendar(); document.getElementById('calendarModal').classList.add('active'); }
        function closeCalendar() { document.getElementById('calendarModal').classList.remove('active'); }
        function prevMonth() { calendarViewDate.setMonth(calendarViewDate.getMonth() - 1); renderCalendar(); }
        function nextMonth() { calendarViewDate.setMonth(calendarViewDate.getMonth() + 1); renderCalendar(); }
        function renderCalendar() {
            document.getElementById('calendarMonth').textContent = `${calendarViewDate.getFullYear()}年 ${calendarViewDate.getMonth() + 1}月`;
            const container = document.getElementById('calendarDays');
            const firstDay = new Date(calendarViewDate.getFullYear(), calendarViewDate.getMonth(), 1);
            const lastDay = new Date(calendarViewDate.getFullYear(), calendarViewDate.getMonth() + 1, 0);
            const startDay = firstDay.getDay();
            const totalDays = lastDay.getDate();
            const today = new Date();
            const prevMonthLastDay = new Date(calendarViewDate.getFullYear(), calendarViewDate.getMonth(), 0).getDate();
            let html = '';
            for (let i = startDay - 1; i >= 0; i--) html += `<button class="calendar-day other-month">${prevMonthLastDay - i}</button>`;
            for (let i = 1; i <= totalDays; i++) {
                const dayDate = new Date(calendarViewDate.getFullYear(), calendarViewDate.getMonth(), i);
                const isToday = formatDate(dayDate) === formatDate(today);
                const isSelected = formatDate(dayDate) === formatDate(currentDate);
                html += `<button class="calendar-day ${isToday ? 'today' : ''} ${isSelected ? 'selected' : ''}" onclick="selectDate(${i})">${i}</button>`;
            }
            const remaining = 42 - (startDay + totalDays);
            for (let i = 1; i <= remaining; i++) html += `<button class="calendar-day other-month">${i}</button>`;
            container.innerHTML = html;
        }
        function selectDate(day) { currentDate = new Date(calendarViewDate.getFullYear(), calendarViewDate.getMonth(), day); closeCalendar(); renderAll(); }

        // Settings
        async function openSettings() {
            document.getElementById('morningStart').value = settings.morningStart;
            document.getElementById('eveningStart').value = settings.eveningStart;
            document.getElementById('appVersion').textContent = APP_VERSION;
            document.getElementById('appLastUpdate').textContent = APP_LAST_UPDATE;
            await loadApiKeys();
            updateThemeToggleUI();
            document.getElementById('settingsModal').classList.add('active');
        }
        function closeSettings() { document.getElementById('settingsModal').classList.remove('active'); }
        async function saveSettings() {
            settings.morningStart = document.getElementById('morningStart').value;
            settings.eveningStart = document.getElementById('eveningStart').value;
            await dbPut('settings', { id: 'routineTimes', ...settings });
            updateTimeRangeDisplay();
            updateDateTime();
            await renderMorningHabits();
            await renderEveningHabits();
            closeSettings();
            showToast('設定を保存しました');
        }
        async function loadSettings() {
            const data = await dbGet('settings', 'routineTimes');
            if (data) {
                settings.morningStart = data.morningStart || '07:00';
                settings.eveningStart = data.eveningStart || '20:00';
            }
            updateTimeRangeDisplay();
        }
        
        // APIキー管理
        async function saveOpenAIKey() {
            const apiKey = document.getElementById('openaiApiKey').value.trim();
            if (!apiKey) {
                showToast('OpenAI APIキーを入力してください');
                return;
            }
            if (!apiKey.startsWith('sk-')) {
                showToast('無効なAPIキー形式です');
                return;
            }
            await dbPut('settings', { id: 'openaiApiKey', key: apiKey });
            showToast('OpenAI APIキーを保存しました ✓');
        }
        
        async function saveNewsDataKey() {
            const apiKey = document.getElementById('newsdataApiKey').value.trim();
            if (!apiKey) {
                showToast('NewsData APIキーを入力してください');
                return;
            }
            await dbPut('settings', { id: 'newsdataApiKey', key: apiKey });
            showToast('NewsData APIキーを保存しました ✓');
        }
        
        async function loadApiKeys() {
            const openaiData = await dbGet('settings', 'openaiApiKey');
            if (openaiData?.key) {
                document.getElementById('openaiApiKey').value = openaiData.key;
            }
            
            const newsdataData = await dbGet('settings', 'newsdataApiKey');
            if (newsdataData?.key) {
                document.getElementById('newsdataApiKey').value = newsdataData.key;
            }
        }
        
        // ==========================================
        // 余白新聞 - 実際のニュースに基づく余白新聞生成
        // ==========================================
        
        async function generateDailyPaper(forceRegenerate = false) {
            const statusEl = document.getElementById('paperStatus');
            const actionArea = document.getElementById('paperActionArea');
            
            const targetDate = getDateKey();
            const targetDateObj = new Date(currentDate);
            const dateStr = `${targetDateObj.getFullYear()}年${targetDateObj.getMonth() + 1}月${targetDateObj.getDate()}日`;
            
            console.log(`=== 余白新聞生成開始: ${targetDate} ===`);
            
            // OpenAI APIキーの確認（必須）
            const openaiKeyData = await dbGet('settings', 'openaiApiKey');
            if (!openaiKeyData?.key) {
                showToast('設定からOpenAI APIキーを入力してください');
                statusEl.textContent = 'OpenAI APIキーが未設定';
                return;
            }
            
            // ニュースAPIキーの取得（任意）
            const newsdataKeyData = await dbGet('settings', 'newsdataApiKey');
            
            // キャッシュ確認
            if (!forceRegenerate) {
                const cachedPaper = await dbGet('notes', `paper-${targetDate}`);
                if (cachedPaper?.content) {
                    console.log('キャッシュから表示');
                    showDailyPaper(cachedPaper.content, targetDate);
                    return;
                }
            }
            
            // UI更新
            actionArea.innerHTML = `
                <div class="paper-generate-btn loading" style="cursor: default;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
                    ニュースを取得中...
                </div>
            `;
            statusEl.textContent = 'ニュースを取得しています...';
            
            try {
                // Step 1: ニュースを取得（複数ソース）- 指定日付のニュースを取得
                console.log('Step 1: ニュース取得 (対象日付: ' + targetDate + ')');
                const newsArticles = await fetchNewsMultiSource(newsdataKeyData?.key, newsKeywords, statusEl, targetDate);
                
                if (newsArticles.length === 0) {
                    throw new Error('ニュースを取得できませんでした。しばらく待ってから再試行してください。');
                }
                
                console.log(`取得したニュース: ${newsArticles.length}件`);
                statusEl.textContent = `${newsArticles.length}件のニュースを取得。AI分析中...`;
                
                // Step 2: GPT-4oで余白新聞を生成
                console.log('Step 2: GPT-4oで余白新聞生成');
                actionArea.innerHTML = `
                    <div class="paper-generate-btn loading" style="cursor: default;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
                        AI分析中...
                    </div>
                `;
                
                const paperContent = await generatePaperFromNews(openaiKeyData.key, newsArticles, dateStr);
                
                // 保存
                await dbPut('notes', { id: `paper-${targetDate}`, content: paperContent, date: targetDate });
                
                // 表示
                showDailyPaper(paperContent, targetDate);
                statusEl.textContent = '余白新聞が生成されました';
                
                // UI更新
                await updatePaperCardForDate();
                await renderPaperArchive();
                
            } catch (error) {
                console.error('余白新聞生成エラー:', error);
                showToast('エラー: ' + error.message);
                statusEl.textContent = 'エラー: ' + error.message;
                await updatePaperCardForDate();
            }
        }
        
        // 再生成（日付を指定してその日のニュースを再取得）
        async function regenerateDailyPaper() {
            await generateDailyPaper(true);
        }
        
        // ==========================================
        // 複数ソースからニュースを取得
        // ==========================================
        async function fetchNewsMultiSource(newsdataApiKey, keywords, statusEl, targetDate) {
            const allArticles = [];
            const seenTitles = new Set();
            
            console.log('=== マルチソース ニュース取得開始 ===');
            console.log('キーワード:', keywords);
            console.log('対象日付:', targetDate);
            
            // ソース1: NewsData.io API（APIキーがある場合）- 日付指定可能
            if (newsdataApiKey) {
                statusEl.textContent = 'NewsData.io からニュースを取得中...';
                const newsDataArticles = await fetchFromNewsDataIO(newsdataApiKey, keywords, seenTitles, targetDate);
                allArticles.push(...newsDataArticles);
                console.log(`NewsData.io: ${newsDataArticles.length}件`);
            }
            
            // ソース2: Google News RSS（常に試行）- 日付フィルタリング
            if (allArticles.length < 20) {
                statusEl.textContent = 'Google News RSS からニュースを取得中...';
                const rssArticles = await fetchFromGoogleNewsRSS(keywords, seenTitles, targetDate);
                allArticles.push(...rssArticles);
                console.log(`Google News RSS: ${rssArticles.length}件`);
            }
            
            console.log(`=== ニュース取得完了: 合計${allArticles.length}件 ===`);
            
            // 日付でフィルタリング（対象日付の前後1日まで許容）
            const targetDateObj = new Date(targetDate);
            const startOfDay = new Date(targetDateObj);
            startOfDay.setDate(startOfDay.getDate() - 1);
            const endOfDay = new Date(targetDateObj);
            endOfDay.setDate(endOfDay.getDate() + 1);
            
            const filteredArticles = allArticles.filter(article => {
                if (!article.publishedAt) return true; // 日付なしは許容
                const pubDate = new Date(article.publishedAt);
                return pubDate >= startOfDay && pubDate <= endOfDay;
            });
            
            console.log(`日付フィルタ後: ${filteredArticles.length}件（${targetDate}±1日）`);
            
            // フィルタ後の記事が少ない場合は全記事を使用
            const finalArticles = filteredArticles.length >= 5 ? filteredArticles : allArticles;
            
            // 最新順にソート
            finalArticles.sort((a, b) => new Date(b.publishedAt || 0) - new Date(a.publishedAt || 0));
            
            return finalArticles;
        }
        
        // NewsData.io からニュース取得（日付指定対応）
        async function fetchFromNewsDataIO(apiKey, keywords, seenTitles, targetDate) {
            const articles = [];
            
            // 対象日付が今日かどうかで使用するAPIを切り替え
            const today = formatDate(new Date());
            const isToday = targetDate === today;
            
            // 日付パラメータを構築（過去の日付の場合はArchive APIを使用）
            // NewsData.io: from_date, to_date は YYYY-MM-DD 形式
            const dateParam = isToday ? '' : `&from_date=${targetDate}&to_date=${targetDate}`;
            const apiEndpoint = isToday ? 'latest' : 'archive';
            
            console.log(`[NewsData.io] API: ${apiEndpoint}, 日付: ${targetDate}`);
            
            // 日本のトップニュース
            try {
                console.log('[NewsData.io] トップニュース取得中...');
                const topUrl = `https://newsdata.io/api/1/${apiEndpoint}?apikey=${apiKey}&language=ja&country=jp${dateParam}`;
                const response = await fetch(topUrl, { signal: AbortSignal.timeout(15000) });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.results) {
                        console.log(`✓ [NewsData.io] トップニュース: ${data.results.length}件`);
                        data.results.forEach(item => {
                            if (!seenTitles.has(item.title)) {
                                seenTitles.add(item.title);
                                articles.push({
                                    keyword: 'トップニュース',
                                    title: item.title || '',
                                    description: item.description || '',
                                    content: item.content || item.description || '',
                                    source: item.source_name || item.source_id || '不明',
                                    publishedAt: item.pubDate,
                                    url: item.link,
                                    image_url: item.image_url || ''
                                });
                            }
                        });
                    }
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    console.warn('[NewsData.io] トップニュース取得失敗:', response.status, errorData.results?.message || '');
                }
            } catch (e) {
                console.warn('[NewsData.io] トップニュース取得エラー:', e.message);
            }
            
            // 各キーワードで検索（最大5キーワード - パーソナライズ重視）
            const priorityKeywords = ['ヘラルボニー', 'ピクシーダストテクノロジーズ', '落合陽一'];
            const sortedKeywords = [
                ...priorityKeywords.filter(k => keywords.includes(k)),
                ...keywords.filter(k => !priorityKeywords.includes(k))
            ];
            
            for (const keyword of sortedKeywords.slice(0, 5)) {
                try {
                    console.log(`[NewsData.io] "${keyword}" 検索中...`);
                    const searchUrl = `https://newsdata.io/api/1/${apiEndpoint}?apikey=${apiKey}&q=${encodeURIComponent(keyword)}&language=ja${dateParam}`;
                    const response = await fetch(searchUrl, { signal: AbortSignal.timeout(15000) });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.results && data.results.length > 0) {
                            console.log(`✓ [NewsData.io] "${keyword}": ${data.results.length}件`);
                            data.results.slice(0, 10).forEach(item => {
                                if (!seenTitles.has(item.title)) {
                                    seenTitles.add(item.title);
                                    articles.push({
                                        keyword: keyword,
                                        title: item.title || '',
                                        description: item.description || '',
                                        content: item.content || item.description || '',
                                        source: item.source_name || item.source_id || '不明',
                                        publishedAt: item.pubDate,
                                        url: item.link,
                                        image_url: item.image_url || ''
                                    });
                                }
                            });
                        }
                    }
                    await new Promise(r => setTimeout(r, 500));
                } catch (e) {
                    console.warn(`[NewsData.io] "${keyword}" 取得エラー:`, e.message);
                }
            }
            
            return articles;
        }
        
        // Google News RSS からニュース取得（フォールバック）- 日付フィルタリング付き
        async function fetchFromGoogleNewsRSS(keywords, seenTitles, targetDate) {
            const articles = [];
            
            // RSS2JSONとAllOriginsの両方を試す
            const proxyServices = [
                {
                    name: 'RSS2JSON',
                    makeUrl: (rssUrl) => `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(rssUrl)}&count=10`,
                    parse: (data) => data.status === 'ok' && data.items ? data.items : null
                },
                {
                    name: 'AllOrigins',
                    makeUrl: (rssUrl) => `https://api.allorigins.win/get?url=${encodeURIComponent(rssUrl)}`,
                    parse: (data) => data.contents ? parseRSSXML(data.contents) : null
                }
            ];
            
            // 日本のトップニュース
            const topNewsUrl = 'https://news.google.com/rss?hl=ja&gl=JP&ceid=JP:ja';
            for (const proxy of proxyServices) {
                try {
                    console.log(`[${proxy.name}] トップニュース取得中...`);
                    const response = await fetch(proxy.makeUrl(topNewsUrl), { signal: AbortSignal.timeout(12000) });
                    const data = await response.json();
                    const items = proxy.parse(data);
                    
                    if (items && items.length > 0) {
                        console.log(`✓ [${proxy.name}] トップニュース: ${items.length}件`);
                        items.slice(0, 20).forEach(item => {
                            const title = cleanHtml(item.title || '');
                            if (title && !seenTitles.has(title)) {
                                seenTitles.add(title);
                                articles.push({
                                    keyword: 'トップニュース',
                                    title: title,
                                    description: cleanHtml(item.description || ''),
                                    content: cleanHtml(item.description || ''),
                                    source: extractSource(title),
                                    publishedAt: item.pubDate || item.pubdate,
                                    url: item.link
                                });
                            }
                        });
                        break;
                    }
                } catch (e) {
                    console.warn(`[${proxy.name}] トップニュース取得失敗:`, e.message);
                }
            }
            
            // 各キーワードで検索
            for (const keyword of keywords) {
                const rssUrl = `https://news.google.com/rss/search?q=${encodeURIComponent(keyword)}&hl=ja&gl=JP&ceid=JP:ja`;
                
                for (const proxy of proxyServices) {
                    try {
                        console.log(`[${proxy.name}] "${keyword}" 検索中...`);
                        const response = await fetch(proxy.makeUrl(rssUrl), { signal: AbortSignal.timeout(12000) });
                        const data = await response.json();
                        const items = proxy.parse(data);
                        
                        if (items && items.length > 0) {
                            console.log(`✓ [${proxy.name}] "${keyword}": ${items.length}件`);
                            items.slice(0, 10).forEach(item => {
                                const title = cleanHtml(item.title || '');
                                if (title && !seenTitles.has(title)) {
                                    seenTitles.add(title);
                                    articles.push({
                                        keyword: keyword,
                                        title: title,
                                        description: cleanHtml(item.description || ''),
                                        content: cleanHtml(item.description || ''),
                                        source: extractSource(title),
                                        publishedAt: item.pubDate || item.pubdate,
                                        url: item.link
                                    });
                                }
                            });
                            break;
                        }
                    } catch (e) {
                        console.warn(`[${proxy.name}] "${keyword}" 取得失敗:`, e.message);
                    }
                }
                await new Promise(r => setTimeout(r, 300));
            }
            
            return articles;
        }
        
        // RSSのXMLをパース
        function parseRSSXML(xmlString) {
            try {
                const parser = new DOMParser();
                const doc = parser.parseFromString(xmlString, 'text/xml');
                const items = doc.querySelectorAll('item');
                return Array.from(items).map(item => ({
                    title: item.querySelector('title')?.textContent || '',
                    description: item.querySelector('description')?.textContent || '',
                    link: item.querySelector('link')?.textContent || '',
                    pubDate: item.querySelector('pubDate')?.textContent || ''
                }));
            } catch (e) {
                return null;
            }
        }
        
        // HTMLタグを除去
        function cleanHtml(html) {
            return (html || '')
                .replace(/<[^>]*>/g, '')
                .replace(/&nbsp;/g, ' ')
                .replace(/&amp;/g, '&')
                .replace(/&lt;/g, '<')
                .replace(/&gt;/g, '>')
                .replace(/&quot;/g, '"')
                .replace(/&#39;/g, "'")
                .replace(/\s+/g, ' ')
                .trim()
                .slice(0, 500);
        }
        
        // ニュースソースを抽出
        function extractSource(title) {
            const match = title.match(/ - ([^-]+)$/);
            return match ? match[1].trim() : 'Google News';
        }
        
        // ==========================================
        // GPT-4o で高品質な余白新聞を生成
        // ==========================================
        async function generatePaperFromNews(apiKey, newsArticles, dateStr) {
            // ニュースをカテゴリ別に整理
            const newsByCategory = {};
            newsArticles.forEach(article => {
                const cat = article.keyword || 'その他';
                if (!newsByCategory[cat]) newsByCategory[cat] = [];
                newsByCategory[cat].push(article);
            });
            
            // ニュースを詳細にフォーマット
            let newsText = '';
            let articleIndex = 1;
            
            for (const [category, articles] of Object.entries(newsByCategory)) {
                newsText += `\n\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`;
                newsText += `【${category}】${articles.length}件のニュース\n`;
                newsText += `━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`;
                
                articles.forEach(article => {
                    const pubDate = article.publishedAt ? new Date(article.publishedAt).toLocaleString('ja-JP') : '日時不明';
                    newsText += `\n[記事${articleIndex}] ${article.title}\n`;
                    newsText += `出典: ${article.source} | ${pubDate}\n`;
                    newsText += `概要: ${article.description || '（概要なし）'}\n`;
                    if (article.content && article.content !== article.description) {
                        newsText += `本文抜粋: ${article.content.slice(0, 500)}${article.content.length > 500 ? '...' : ''}\n`;
                    }
                    newsText += `URL: ${article.url}\n`;
                    if (article.image) {
                        newsText += `画像URL: ${article.image}\n`;
                    }
                    articleIndex++;
                });
            }
            
            const totalNewsCount = newsArticles.length;
            
            // 徹底的に改善したプロンプト
            const prompt = `# 🗞️ 余白新聞 編集指示書

あなたは「余白新聞」という個人向けプレミアム・デイリーレポートの編集長です。
**実際のニュース記事**を分析し、読者専用の価値ある余白新聞を作成してください。

## 📅 発行日
${dateStr}

## 👤 読者プロフィール
- **職業**: テクノロジー企業の起業家（30代男性）
- **会社**: 難聴支援や介護福祉×テクノロジーに関連
- **興味関心**:
  1. AI・生成AI・テクノロジー最新動向
  2. 介護・福祉・医療（ケアテック）
  3. 難聴・聴覚支援技術
  4. ヘラルボニー（障害のある方のアート）
  5. ピクシーダストテクノロジーズ（落合陽一）
  6. アート・文化・デザイン
  7. スタートアップ・起業
- **価値観**: 「余白」を大切にする（効率だけでなく人間らしい豊かさを追求）
- **読書時間**: 朝の15-20分をかけてじっくり読む

## 📰 本日取得したニュース（${totalNewsCount}件）
${newsText}

## ✍️ 執筆要件（厳守）

### 絶対に守るべきルール
1. **実際のニュース記事の内容のみ**を元に執筆する
2. **架空の情報や想像で補完しない**
3. 各ニュースの**事実**を正確に伝え、そこから**分析**と**示唆**を導く
4. 読み応えのある**充実したボリューム**（合計3000-4000文字程度）

### 1. ヘッドライン（必須）
- その日のニュースを象徴する**印象的な一言**
- **18-22文字**
- 記憶に残るキャッチーな表現
- 例: 「AIと人の境界、揺らぐ日」「ケアの未来、静かに動く」

### 2. エグゼクティブサマリー（必須）
- **400-500文字**
- 今日押さえるべき**重要ポイント3-4つ**を明確に
- ビジネスパーソンが1分で全体像を把握できる構成
- 各ポイントは具体的なニュースに基づく

### 3. トピックセクション（提供されたニュース全てをカバー）
- **提供されたニュース記事を全て使い切る**こと（**最低15-20セクション**）
- 重要なニュースは単独セクション、関連性の高いニュースのみまとめてOK
- 各セクションは**実際のニュース記事**を元に以下の構成で**700-1000文字**:

**【セクションタイトル】**
ニュースの内容を反映した具体的なタイトル

**【ニュースファクト】**（250-300文字）
- 何が起きたか（Who, What, When, Where）
- 数字や固有名詞を含む具体的な事実
- 出典を明記

**【背景・文脈と深掘り解説】**（350-450文字）
- なぜこれが重要なのか
- 業界や社会における位置づけ
- 関連する過去の動きや他のニュースとの関連
- この出来事の本質的な意味
- 今後の展開の予測や影響範囲

**【読者への示唆】**（200-250文字）
- この情報を読者（起業家）はどう活かせるか
- ビジネスや事業への具体的な示唆
- 考えるべきポイントや問いかけ

### 4. 今日の問い（必須）
- 読者が1日かけて考える価値のある**深い問いかけ**
- ニュースから導き出される本質的な問い
- **60-100文字**
- 哲学的かつ実践的

### 5. クロージング（必須）
- 「余白」の哲学を反映した締めくくり
- 効率や成果だけでない価値を示唆
- 明日への希望を感じさせる
- **80-120文字**

## 📝 出力JSON形式

\`\`\`json
{
  "headline": "ヘッドライン（18-22文字）",
  "summary": "エグゼクティブサマリー（400-500文字）",
  "sections": [
    {
      "title": "セクションタイトル（具体的に）",
      "emoji": "適切な絵文字1つ",
      "news_summary": "ニュースファクト（250-300文字・出典明記）",
      "analysis": "背景・文脈と深掘り解説（350-450文字）",
      "insight": "読者への示唆（200-250文字）",
      "source": "記事の出典メディア名",
      "source_title": "引用した元記事のタイトル（そのままコピー）",
      "source_url": "引用した記事のURL（提供されたURLをそのまま使用）",
      "image_url": "記事の画像URL（提供されていればそのままコピー、なければ空文字）"
    }
  ],
  "question_of_day": "今日の問い（60-100文字）",
  "closing": "クロージング（80-120文字）",
  "news_count": ${totalNewsCount},
  "generated_date": "${dateStr}",
  "sources": ["引用したメディア名のリスト"]
}
\`\`\`

## ⚠️ 重要な制約
1. **必ず有効なJSONのみ**を出力（説明文や前置きは不要）
2. **提供されたニュースを全て使い切る**（**最低15-20セクション**）
3. **各セクションは実際のニュースに基づく**こと
4. 架空の情報を含めない
5. セクションタイトルは「〇〇について」のような抽象的なものではなく、**具体的なニュース内容を反映**したものに
6. 出典（メディア名）を必ず含める
7. **source_url は必須**：各セクションに引用した記事のURLを必ず含める（提供されたURLをそのままコピー）
8. **ニュースの鮮度を重視**：本日のニュースを優先して使用する
9. **量を重視**：できるだけ多くのニュースを取り上げ、読者に幅広い情報を提供する

## 🚨 MECE原則（絶対遵守）
- **1つのニュースは1つのセクションでのみ使用**すること
- 同じニュースを複数のセクションで重複して取り上げない
- 各セクションの内容は相互に排他的であること
- セクション分けはMECE（Mutually Exclusive, Collectively Exhaustive）を厳守

## ⭐ 最優先キーワード処理（必須・絶対遵守）

以下の2社については、**必ず専用セクションを作成**すること。これは最も重要なルールです。

### 1. ヘラルボニー（HERALBONY）
- ニュースがある場合：「🎨 ヘラルボニー」専用セクションを作成し、ニュース内容を詳細に解説
- **ニュースがない場合も必ず以下のセクションを作成**：
  - タイトル：「🎨 ヘラルボニー定点観測」
  - 内容：「本日のニュース検索では、ヘラルボニーに関する新着ニュースは確認されませんでした。」
  - 加えて、読者への価値として：最近の動向のリマインド、または次に注目すべきポイントを簡潔に記載

### 2. ピクシーダストテクノロジーズ / 落合陽一
- ニュースがある場合：「🔬 ピクシーダストテクノロジーズ」専用セクションを作成し、ニュース内容を詳細に解説
- **ニュースがない場合も必ず以下のセクションを作成**：
  - タイトル：「🔬 ピクシーダストテクノロジーズ定点観測」
  - 内容：「本日のニュース検索では、ピクシーダストテクノロジーズ（PxDT）および落合陽一氏に関する新着ニュースは確認されませんでした。」
  - 加えて、読者への価値として：直近の事業展開や注目点を簡潔に記載

※これら2社のセクションは**必ず新聞の冒頭付近（エグゼクティブサマリーの直後）**に配置すること
※他のニュースとまとめず、必ず独立したセクションとして扱うこと`;

            console.log('GPT-4o 呼び出し開始...');
            console.log('プロンプト文字数:', prompt.length);
            
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: 'gpt-4o',
                    messages: [
                        {
                            role: 'system',
                            content: `あなたは「余白新聞」の編集長です。
実際のニュース記事を分析し、読者に価値ある洞察を提供する高品質な余白新聞を作成します。

重要なルール:
1. 提供されたニュース記事の内容のみを使用する
2. 架空の情報や想像で補完しない
3. 各セクションは必ず実際のニュースに基づく
4. 出典（メディア名）とsource_url（記事URL）を必ず含める
5. source_urlは提供された記事のURLをそのままコピーする
6. 必ずJSON形式のみで出力する（説明文不要）`
                        },
                        { role: 'user', content: prompt }
                    ],
                    temperature: 0.7,
                    max_tokens: 16000
                })
            });
            
            if (!response.ok) {
                const error = await response.json();
                console.error('OpenAI API Error:', error);
                throw new Error(error.error?.message || 'OpenAI APIエラー');
            }
            
            const data = await response.json();
            const content = data.choices[0].message.content;
            
            console.log('GPT Response 文字数:', content.length);
            console.log('使用トークン:', data.usage);
            
            // JSONをパース
            let jsonStr = content;
            
            // ```json ... ``` 形式を処理
            const codeBlockMatch = content.match(/```json\s*([\s\S]*?)\s*```/);
            if (codeBlockMatch) {
                jsonStr = codeBlockMatch[1];
            } else {
                const jsonMatch = content.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    jsonStr = jsonMatch[0];
                }
            }
            
            if (!jsonStr || !jsonStr.includes('{')) {
                console.error('Invalid JSON:', content.slice(0, 500));
                throw new Error('有効なJSONが返されませんでした');
            }
            
            try {
                const parsed = JSON.parse(jsonStr);
                console.log('✓ パース成功');
                console.log('  - ヘッドライン:', parsed.headline);
                console.log('  - セクション数:', parsed.sections?.length || 0);
                console.log('  - サマリー文字数:', parsed.summary?.length || 0);
                return parsed;
            } catch (e) {
                console.error('JSON parse error:', e);
                console.error('Input:', jsonStr.slice(0, 1000));
                throw new Error('JSONパースエラー');
            }
        }
        
        // 余白新聞を表示（プレミアム版）
        function showDailyPaper(content, date) {
            const paper = document.getElementById('dailyPaper');
            const paperDate = document.getElementById('paperDate');
            const paperContent = document.getElementById('paperContent');
            
            const dateObj = new Date(date);
            const weekday = ['日', '月', '火', '水', '木', '金', '土'][dateObj.getDay()];
            paperDate.textContent = `${dateObj.getFullYear()}年${dateObj.getMonth() + 1}月${dateObj.getDate()}日（${weekday}）`;
            
            // ヘッダー部分
            let html = `
                <div class="paper-section">
                    <div class="paper-headline" style="font-size: 24px; text-align: center; margin-bottom: 20px; color: #8b5a2b; font-family: var(--font-serif); letter-spacing: 0.05em;">
                        「${content.headline || '本日の余白新聞'}」
                    </div>
                    ${content.news_count ? `<div style="text-align: center; font-size: 11px; color: var(--text-muted); margin-bottom: 16px;">📰 ${content.news_count}件のニュースを分析</div>` : ''}
                    <div class="paper-summary" style="background: rgba(139,90,43,0.08); padding: 20px; border-radius: 10px; border-left: 4px solid #8b5a2b;">
                        <div style="font-size: 11px; color: #8b5a2b; margin-bottom: 10px; font-weight: 600; letter-spacing: 0.1em;">📋 EXECUTIVE SUMMARY</div>
                        <div style="font-size: 14px; line-height: 1.9; white-space: pre-line;">${content.summary || ''}</div>
                    </div>
                </div>
            `;
            
            // 各セクション
            content.sections?.forEach((section, idx) => {
                const newsSum = section.news_summary || '';
                const analysis = section.analysis || section.content || '';
                const insight = section.insight || '';
                const source = section.source || '';
                const sourceTitle = section.source_title || '';
                const sourceUrl = section.source_url || '';
                const imageUrl = section.image_url || '';
                
                html += `
                    <div class="paper-section" style="border-left: 3px solid rgba(139,90,43,0.3); padding-left: 16px; margin-left: 8px;">
                        <div class="paper-section-title" style="font-size: 17px; margin-bottom: 16px;">
                            ${section.emoji || '📌'} ${section.title}
                        </div>
                        
                        ${newsSum ? `
                            <div style="margin-bottom: 16px;">
                                <div style="font-size: 10px; color: var(--accent-blue); margin-bottom: 6px; font-weight: 600;">📰 WHAT HAPPENED</div>
                                <div style="font-size: 14px; color: var(--text-secondary); line-height: 1.8; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">${newsSum}</div>
                            </div>
                        ` : ''}
                        
                        ${analysis ? `
                            <div style="margin-bottom: 16px;">
                                <div style="font-size: 10px; color: var(--accent-sage); margin-bottom: 6px; font-weight: 600;">🔍 CONTEXT & ANALYSIS</div>
                                <div style="font-size: 14px; line-height: 1.9;">${analysis}</div>
                            </div>
                        ` : ''}
                        
                        ${insight ? `
                            <div style="background: rgba(107,143,113,0.1); padding: 14px; border-radius: 8px; border-left: 3px solid var(--accent-sage); margin-bottom: 12px;">
                                <div style="font-size: 10px; color: var(--accent-sage); margin-bottom: 6px; font-weight: 600;">💡 INSIGHT FOR YOU</div>
                                <div style="font-size: 13px; line-height: 1.8; font-style: italic;">${insight}</div>
                            </div>
                        ` : ''}
                        
                        <!-- 引用元（画像プレビュー付き） -->
                        <div style="padding: 12px; background: var(--bg-secondary); border-radius: 10px; font-size: 12px;">
                            ${imageUrl ? `
                                <div style="margin-bottom: 10px; border-radius: 8px; overflow: hidden;">
                                    <img src="${imageUrl}" alt="" 
                                         style="width: 100%; height: auto; max-height: 180px; object-fit: cover; display: block;"
                                         onerror="this.style.display='none'">
                                </div>
                            ` : ''}
                            <div style="color: var(--text-muted); margin-bottom: 4px; font-size: 10px;">📎 出典${source ? `: ${source}` : ''}</div>
                            ${sourceUrl ? `
                                <a href="${sourceUrl}" target="_blank" rel="noopener noreferrer" 
                                   style="color: var(--accent-blue); text-decoration: none; line-height: 1.5; display: block; font-size: 13px;">
                                    ${sourceTitle || '元記事を確認 →'}
                                </a>
                            ` : (sourceTitle ? `<span style="color: var(--text-secondary);">${sourceTitle}</span>` : '')}
                        </div>
                    </div>
                `;
            });
            
            // 今日の問い
            if (content.question_of_day) {
                html += `
                    <div class="paper-section" style="text-align: center; background: linear-gradient(135deg, rgba(139,90,43,0.12) 0%, rgba(107,143,113,0.12) 100%); padding: 28px; border-radius: 14px; margin: 24px 0;">
                        <div style="font-size: 11px; color: #8b5a2b; margin-bottom: 12px; letter-spacing: 0.15em; font-weight: 600;">🤔 TODAY'S QUESTION</div>
                        <div style="font-family: var(--font-serif); font-size: 17px; color: var(--text-primary); line-height: 1.9;">
                            ${content.question_of_day}
                        </div>
                    </div>
                `;
            }
            
            // クロージング
            html += `
                <div class="paper-section" style="text-align: center; border-bottom: none; padding-top: 24px;">
                    <div style="font-family: var(--font-serif); font-size: 15px; color: #8b5a2b; font-style: italic; line-height: 1.8;">
                        ✨ ${content.closing || '今日も良い一日を。'}
                    </div>
                    <div style="margin-top: 24px; padding-top: 20px; border-top: 1px dashed rgba(139,90,43,0.3); font-size: 11px; color: var(--text-muted);">
                        余白新聞 — 質量と余白の間で、今日を知る<br>
                        <span style="font-size: 10px; opacity: 0.7;">${content.generated_date || ''}</span>
                    </div>
                </div>
            `;
            
            paperContent.innerHTML = html;
            paper.style.display = 'block';
            paper.scrollTop = 0; // 一番上から表示
            document.body.style.overflow = 'hidden';
        }
        
        function closeDailyPaper() {
            document.getElementById('dailyPaper').style.display = 'none';
            document.body.style.overflow = '';
            renderPaperArchive(); // アーカイブを更新
        }
        
        // 余白新聞アーカイブ表示
        async function renderPaperArchive() {
            const container = document.getElementById('paperArchiveList');
            const allNotes = await dbGetAll('notes');
            
            // paper-で始まるものをフィルタ
            const papers = allNotes
                .filter(n => n.id.startsWith('paper-') && n.content)
                .sort((a, b) => b.date.localeCompare(a.date))
                .slice(0, 10); // 最新10件
            
            if (papers.length === 0) {
                container.innerHTML = '<div class="paper-archive-empty">まだ余白新聞がありません</div>';
                return;
            }
            
            const selectedDate = getDateKey();
            
            container.innerHTML = papers.map(p => {
                const dateObj = new Date(p.date);
                const weekday = ['日', '月', '火', '水', '木', '金', '土'][dateObj.getDay()];
                const headline = p.content.headline || '余白新聞';
                const isToday = p.date === formatDate(new Date());
                const isSelected = p.date === selectedDate;
                
                return `
                    <div class="paper-archive-item" style="${isSelected ? 'border-color: var(--accent-gold); background: var(--accent-gold-dim);' : ''}" onclick="showDailyPaper(${JSON.stringify(p.content).replace(/"/g, '&quot;')}, '${p.date}')">
                        <div>
                            <div class="paper-archive-date">${dateObj.getMonth() + 1}/${dateObj.getDate()}（${weekday}）</div>
                            <div class="paper-archive-headline">${headline}</div>
                        </div>
                        ${isToday ? '<span class="paper-archive-badge">TODAY</span>' : isSelected ? '<span class="paper-archive-badge" style="background: var(--accent-gold);">選択中</span>' : '<span style="color: var(--text-muted); font-size: 12px;">→</span>'}
                    </div>
                `;
            }).join('');
        }
        
        // 選択された日付の余白新聞状態を更新
        async function updatePaperCardForDate() {
            const dateKey = getDateKey();
            const today = formatDate(new Date());
            const isToday = dateKey === today;
            const isFuture = new Date(currentDate) > new Date();
            
            const titleEl = document.getElementById('paperCardTitle');
            const statusEl = document.getElementById('paperStatus');
            const actionArea = document.getElementById('paperActionArea');
            
            const dateObj = new Date(currentDate);
            const weekday = ['日', '月', '火', '水', '木', '金', '土'][dateObj.getDay()];
            const dateStr = `${dateObj.getMonth() + 1}/${dateObj.getDate()}（${weekday}）`;
            
            // その日の余白新聞があるか確認
            const cachedPaper = await dbGet('notes', `paper-${dateKey}`);
            
            if (cachedPaper?.content) {
                // 余白新聞がある場合
                titleEl.textContent = `${dateStr} の余白新聞`;
                statusEl.textContent = `「${cachedPaper.content.headline || '余白新聞'}」`;
                
                // 再生成ボタン（過去日付はその日のニュースで再生成）
                const regenerateLabel = isToday ? '再生成' : `${dateStr}のニュースで再生成`;
                
                actionArea.innerHTML = `
                    <button class="paper-generate-btn" onclick="showDailyPaper(window._cachedPaperContent, '${dateKey}')" style="background: linear-gradient(135deg, var(--accent-sage) 0%, #4a7050 100%);">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                        余白新聞を読む
                    </button>
                    <button class="paper-generate-btn" onclick="regenerateDailyPaper()" style="margin-top: 8px; background: transparent; border: 1px solid var(--border-medium); color: var(--text-secondary);">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
                        ${regenerateLabel}
                    </button>
                `;
                // グローバルにキャッシュ
                window._cachedPaperContent = cachedPaper.content;
            } else if (isFuture) {
                // 未来の日付
                titleEl.textContent = `${dateStr} の余白新聞`;
                statusEl.textContent = '未来の余白新聞は生成できません';
                actionArea.innerHTML = `
                    <div style="text-align: center; padding: 16px; color: var(--text-muted); font-size: 13px;">
                        🔮 この日はまだ来ていません
                    </div>
                `;
            } else {
                // 余白新聞がない場合（今日または過去）
                titleEl.textContent = isToday ? '今日の余白新聞' : `${dateStr} の余白新聞`;
                statusEl.textContent = isToday ? 'AIが今日のニュースを要約します' : 'この日の余白新聞を遡って生成できます';
                actionArea.innerHTML = `
                    <button class="paper-generate-btn" onclick="generateDailyPaper()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
                        ${isToday ? '余白新聞を生成' : 'この日の余白新聞を生成'}
                    </button>
                `;
            }
        }
        
        // アプリの強制更新
        async function forceUpdateApp() {
            showToast('更新を確認中...');
            
            try {
                // Service Workerのキャッシュをクリア
                if ('caches' in window) {
                    const cacheNames = await caches.keys();
                    await Promise.all(cacheNames.map(name => caches.delete(name)));
                }
                
                // Service Workerを更新
                if ('serviceWorker' in navigator) {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    for (const registration of registrations) {
                        await registration.update();
                    }
                }
                
                // ハードリロード（キャッシュを無視）
                showToast('更新しています...');
                setTimeout(() => {
                    // URLにタイムスタンプを追加してキャッシュを回避
                    const url = new URL(window.location.href);
                    url.searchParams.set('_refresh', Date.now());
                    window.location.href = url.toString();
                }, 500);
                
            } catch (error) {
                console.error('Update error:', error);
                // フォールバック: 通常のリロード
                window.location.reload(true);
            }
        }

        // Add Book
        function openAddBookModal() { document.getElementById('addBookModal').classList.add('active'); document.getElementById('bookTitleInput').value = ''; document.getElementById('bookAuthorInput').value = ''; }
        function closeAddBookModal() { document.getElementById('addBookModal').classList.remove('active'); }
        async function addCustomBook() {
            const title = document.getElementById('bookTitleInput').value.trim();
            const author = document.getElementById('bookAuthorInput').value.trim();
            if (!title) { showToast('タイトルを入力してください'); return; }
            await dbPut('customBooks', { title, author, month: currentDate.getMonth() + 1, completed: false, createdAt: new Date().toISOString() });
            closeAddBookModal(); renderBookList(); showToast('本を追加しました');
        }

        // Image Upload
        document.getElementById('imageUploadArea').addEventListener('click', () => document.getElementById('imageInput').click());
        document.getElementById('imageInput').addEventListener('change', async (e) => {
            const files = Array.from(e.target.files);
            const dateKey = getDateKey();
            const data = await dbGet('images', dateKey) || { id: dateKey, images: [] };
            for (const file of files) {
                const reader = new FileReader();
                reader.onload = async (ev) => { data.images.push(ev.target.result); await dbPut('images', data); renderUploadedImages(); showToast('画像を追加しました'); };
                reader.readAsDataURL(file);
            }
            e.target.value = '';
        });
        async function removeImage(index) {
            const data = await dbGet('images', getDateKey());
            if (data?.images) { data.images.splice(index, 1); await dbPut('images', data); renderUploadedImages(); showToast('画像を削除しました'); }
        }

        // Note
        let noteTimeout;
        document.getElementById('dailyNote').addEventListener('input', (e) => {
            clearTimeout(noteTimeout);
            noteTimeout = setTimeout(async () => { await dbPut('notes', { id: getDateKey(), text: e.target.value }); showToast(); }, 500);
        });

        // Navigation
        document.querySelectorAll('.nav-item').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById(btn.dataset.view).classList.add('active');
                if (btn.dataset.view === 'newsView') { renderKeywordTags(); renderNews(); renderPaperArchive(); updatePaperCardForDate(); }
                if (btn.dataset.view === 'planView') { renderPlanTabs(); renderFiveYearPlan(); }
            });
        });
        document.getElementById('prevDay').addEventListener('click', () => { currentDate.setDate(currentDate.getDate() - 1); renderAll(); });
        document.getElementById('nextDay').addEventListener('click', () => { currentDate.setDate(currentDate.getDate() + 1); renderAll(); });

        // ============================================
        // INIT
        // ============================================
        async function renderAll() {
            updateDateDisplay();
            updateQuote();
            updateMonthCard();
            await renderMorningHabits();
            await renderDaytimeHabits();
            await renderEveningHabits();
            await renderNightHabits();
            await renderStrengthHabits();
            await renderHealthGrid();
            await renderDailyNote();
            await renderUploadedImages();
            await renderWeekCalendar();
            renderWeeklyActivities();
            await renderBookList();
            await renderYearGoals();
            renderMonthTabs();
            await renderMonthGoals();
            renderPlanTabs();
            renderFiveYearPlan();
            await renderStats();
            await updatePaperCardForDate(); // 余白新聞カード更新
            await renderPaperArchive(); // 余白新聞アーカイブ更新
        }

        async function init() {
            try {
                await initDB();
                await migrateHabitData(); // データマイグレーション
                await loadSettings();
                await loadThemeSettings(); // テーマ設定を読み込み
                await loadKeywords();
                updateDateTime();
                setInterval(updateDateTime, 1000);
                setInterval(updateTheme, 60000);
                selectedGoalMonth = currentDate.getMonth() + 1;
                await renderAll();
            } catch (error) { console.error('Init error:', error); }
        }

        init();
    </script>
</body>
</html>
